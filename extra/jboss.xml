<project name="jboss" basedir="." >
	<property environment="env"/>

    <property name="appserver.home" value="${env.APPSRV_HOME}"/>
    <property name="jboss.config" value="default"/>
    <property name="jboss.farm.name" value="deploy"/>
	<property name="jboss.server.home.dir" location="${appserver.home}/server/${jboss.config}"/>
    <property name="jboss.conf.dir" location="${jboss.server.home.dir}/conf"/>
	<property name="jboss.farm.dir" location="${jboss.server.home.dir}/${jboss.farm.name}"/>
	<property name="jboss.deploy.dir" location="${jboss.server.home.dir}/deploy"/>
	<property name="keystore.file" value="conf/keystore/extrakeystore.p12"/>
	<property name="scepkeystore.file" value="conf/keystore/sceprakeystore.p12"/>

    <!-- A little special something to handle backward compatibility with 
         people using JBOSS_HOME. They can switch to APPSRV_HOME now, and both will work. 
    -->        
    <condition property="jboss.home" value="${env.JBOSS_HOME}" >
        <equals arg1="${appserver.home}" arg2="${appserver.home}"/>
    </condition>
    <condition property="appserver.home" value="${env.APPSRV_HOME}" else="${jboss.home}">
        <contains string="${jboss.home}" substring="JBOSS_HOME"/>
    </condition>

	
	<target name="j2ee:check">
        <!--
            we could have a dedicated jboss for ejbca, so give users a chance to override
            otherwise, try to pick the one from environment if it exists
            -->
        <fail message="Please set the property 'appserver.home' for this project" unless="appserver.home"/>
        <available file="${appserver.home}/client/jboss-j2ee.jar" property="appserver.home.valid"/>
        <fail message="'appserver.home' (${appserver.home}) does not seem to be a valid JBoss home directory" unless="appserver.home.valid"/>
        <echo message="Using appserver.home : ${appserver.home}"/>
	</target>

	<!-- Configure the J2EE server with appropriate settings for the RA CA Service-->
	<target name="j2ee:configure" depends="j2ee:check">
        <available file="./keystore/extrakeystore.p12" property="extraserver.keystore.found"/>
        <fail message="The Ext RA keystore could not be found in 'keystore/extrakeystore.p12'" unless="extraserver.keystore.found"/>
		<copy file="keystore/extrakeystore.p12" tofile="${jboss.server.home.dir}/${keystore.file}"/>
	</target>

	<!-- Deploy the RA CA Service -->
	<target name="j2ee:deploy-ra-caservice" depends="j2ee:check">
		<copy todir="${jboss.farm.dir}" file="${extracajbossservicejar}"/>
		
		<copy todir="${jboss.farm.dir}" file="${extrajbosshibernitehar}"/>
		<copy todir="${jboss.farm.dir}">
          <fileset dir="src/appserver/jboss">
        	<include name="ramessage-ds.xml"/>
          </fileset>
		</copy>	
	</target>

	<!-- Configure the J2EE server with appropriate settings for the SCEP RA server-->
	<target name="j2ee:scepraconfigure" depends="j2ee:check">
        <available file="./keystore/sceprakeystore.p12" property="scepraserver.keystore.found"/>
        <fail message="The SCEP RA keystore could not be found in 'keystore/sceprakeystore.p12'" unless="scepraserver.keystore.found"/>
		<copy file="keystore/sceprakeystore.p12" tofile="${jboss.server.home.dir}/${scepkeystore.file}"/>
	</target>

	<!-- Deploy the SCEP ra server war application -->
	<target name="j2ee:deployscepraserver" depends="j2ee:scepraconfigure">
    	<copy todir="${jboss.farm.dir}" file="${scepraserverwar}"/>  		
		<copy todir="${jboss.farm.dir}">
          <fileset dir="src/appserver/jboss">
        	<include name="ramessage-ds.xml"/>
          </fileset>
		</copy>	
	</target>
	
	<target name="j2ee:assert-run" description="Check that the server is running">
        <echo message="Checking that the J2EE server is up and running..."/>
        <waitfor maxwait="2" maxwaitunit="second" timeoutproperty="j2ee.notrunning">
            <http url="http://localhost:8080/web-console/"/>
        </waitfor>
        <fail message="Please start J2EE server before running this script" if="j2ee.notrunning"/>	
	</target>


	<target name="j2ee:run" description="Start the J2EE server">
    	<j2ee-server classname="org.jboss.Main" classpath="${appserver.home}/bin/run.jar">
            <args>
                <jvmarg value="-Djboss.home=${appserver.home}"/>
            </args>
    	</j2ee-server>
    <!--
            jboss.home.dir
            jboss.home.url			${jboss.home.dir}
            jboss.server.name		default
            jboss.server.base.dir	${jboss.home.dir}/server	
            jboss.server.home.dir	${jboss.base.dir}/${jboss.server.name}
            jboss.server.temp.dir	${jboss.server.home.dir}/tmp
            jboss.server.data.dir	${jboss.server.home.dir}/data
            jboss.server.base.url	${jboss.home.url}/server
            jboss.server.home.url	${jboss.base.url}/${jboss.server.name}
            jboss.server.config.url ${jboss.server.home.url}/conf
            jboss.server.lib.url	${jboss.server.home.url}/lib
        -->		
	</target>
    
	<target name="j2ee:debug" description="Start the J2EE server in debug mode">
    	<property name="j2ee.debug.transport" value="dt_socket"/>
    	<property name="j2ee.debug.address" value="5005"/>
    	<property name="j2ee.debug.jvm.opts" value="-Xdebug -Xnoagent -Xrunjdwp:transport=${j2ee.debug.transport},address=${j2ee.debug.address},server=y,suspend=y"/>
		<echo message="Connect your debugger using transport '${j2ee.debug.transport}' and address '${j2ee.debug.address}'"/>
		<antcall target="j2ee:run"/>
	</target>
	
    <macrodef name="j2ee-server">
		<attribute name="classname"/>
		<attribute name="classpath"/>
        <element name="args" optional="yes"/>
        <sequential>
        <property name="j2ee.debug.jvm.opts" value=""/>
		<available file="${java.home}/../lib/tools.jar" property="jdk.present"/>
		<fail message="Missing tools.jar in ${java.home}/lib. Please use a java JDK" unless="jdk.present"/>
		<java classname="@{classname}" fork="true">
	    	<classpath path="@{classpath}:${java.home}/../lib/tools.jar"/>
	    	<jvmarg line="${j2ee.debug.jvm.opts}"/>
	    	<args/>
		</java>
        </sequential>
    </macrodef>

</project>

