<project name="jboss" basedir=".." >
	<property environment="env"/>

    <property name="jboss.home" value="${env.JBOSS_HOME}"/>
    <property name="jboss.config" value="default"/>
    <property name="jboss.farm.name" value="deploy"/>
	<property name="jboss.server.home.dir" location="${jboss.home}/server/${jboss.config}"/>
    <property name="jboss.conf.dir" location="${jboss.server.home.dir}/conf"/>
	<property name="jboss.farm.dir" location="${jboss.server.home.dir}/${jboss.farm.name}"/>
	<property name="jboss.deploy.dir" location="${jboss.server.home.dir}/deploy"/>
	<property name="keystore.file" value="conf/sceprakeystore.p12"/>

	<!--
	 Do not configure the servlet container, deploys blindly ears
	 This is ideally passed by the caller and is just here as a reminder
	  -->
	<!--property name="j2ee.web-noconfigure" value="true"/-->
	
	<!-- Check a few configuration settings -->
	<target name="j2ee:check">
        <!--
            we could have a dedicated jboss for ejbca, so give users a chance to override
            otherwise, try to pick the one from environment if it exists
            -->
        <fail message="Please set the property 'jboss.home' for this project" unless="jboss.home"/>
        <available file="${jboss.home}/client/jboss-j2ee.jar" property="jboss.home.valid"/>
        <fail message="'jboss.home' (${jboss.home}) does not seem to be a valid JBoss home directory" unless="jboss.home.valid"/>
        <echo message="Using jboss.home : ${jboss.home}"/>
	</target>

	<!-- Configure the J2EE server with appropriate settings -->
	<target name="j2ee:configure" depends="j2ee:check">
        <available file="./keystore/sceprakeystore.p12" property="scepraserver.keystore.found"/>
        <fail message="The SCEP RA keystore could not be found in 'keystore/sceprakeystore.p12'" unless="scepraserver.keystore.found"/>
		<copy file="keystore/sceprakeystore.p12" tofile="${jboss.server.home.dir}/${keystore.file}"/>
	</target>

	<!-- Deploy the SCEP ra server war application -->
	<target name="j2ee:deployscepraserver" depends="j2ee:configure">
    	<copy todir="${jboss.farm.dir}" file="${scepraserverwar}"/>  
		<!--
		<copy todir="${jboss.farm.dir}" file="${sceprajbosshibernitehar}"/> 
		<copy todir="${jboss.farm.dir}">
          <fileset dir="src/appserver/jboss">
        	<include name="ramessage-ds.xml"/>
          </fileset>
		</copy>	
		-->
	</target>
	

	<!-- Check that the server is running -->
	<target name="j2ee:assert-run">
        <echo message="Checking that the J2EE server is up and running..."/>
        <waitfor maxwait="2" maxwaitunit="second" timeoutproperty="j2ee.notrunning">
            <http url="http://localhost:8080/web-console/"/>
        </waitfor>
        <fail message="Please start J2EE server before running this script" if="j2ee.notrunning"/>	
	</target>


</project>

