<?xml version="1.0"?>
<project name="SCEPRAServer" default="scepraserver" basedir=".">

	<property name="scepraserver.src" value="${src}/web" />
	<property name="scepraserver.name" value="scepraserver.war" />
    <property name="scepraserver.build" value="${tmp}/${scepraserver.name}" />
    <property name="scepraserverwar" value="${dist.dir}/${scepraserver.name}" />
	
	<property name="sceprajbosshibernate.name" value="sceprajbosshibernate.har" />
    <property name="sceprajbosshibernate.build" value="${tmp}/${sceprajbosshibernate.name}" />
    <property name="sceprajbosshibernatehar" value="${dist.dir}/${sceprajbosshibernate.name}" />		
	
    <zipfileset id="bc.jar" 
            prefix="WEB-INF/lib"
            dir="lib">
        <include name="bcprov-jdk${java.ver}.jar" />
        <include name="bcmail-jdk${java.ver}.jar" />
    </zipfileset>
    <zipfileset id="ejbca.jar" 
            prefix="WEB-INF/lib"
            dir="${ejbca.home}/dist/">
        <include name="ejbca-util.jar" />
    </zipfileset>
    <zipfileset id="extra.jar" 
            prefix="WEB-INF/lib"
            dir="dist/client-jars">
        <include name="ext-raclient.jar" />
    </zipfileset>

    <!-- =================================================================== -->
    <!-- Compile java sources                                                -->
    <!-- =================================================================== -->
    <target name="scepcompile" depends="compile">
        <javac destdir="${build}" debug="on" includeantruntime="no" encoding="iso8859-1">
            <classpath refid="compile.classpath" />
            <src path="${src.java}" />
        	<exclude name="**/jboss/**" />
        </javac>
    	<!-- update web.xml file -->

        <copy todir="${tmp}" overwrite="true">
			<fileset dir="${scepraserver.src}/WEB-INF/">
				<include name="web.xml"/>
			</fileset>	
			<filterchain>
			<tokenfilter>
				<replacestring from="@jboss.conf.dir@" to="${jboss.conf.dir}"/>				
			</tokenfilter>
			</filterchain>
        </copy>
    </target>

    <!-- =================================================================== -->
    <!-- Build SCEPRA Server part, this is the web RA on the external RA server -->
    <!-- =================================================================== -->
    <target name="scepraserver" depends="scepcompile, sceprajbosshibernate" description="Builds the scep ra server scepraserver.war">
        <war destfile="${scepraserverwar}" webxml="${tmp}/web.xml">
            <zipfileset refid="bc.jar"/>
            <zipfileset refid="ejbca.jar"/>
            <zipfileset refid="extra.jar"/>
            <classes dir="${build}">
                <exclude name="**/CVS/**" />
            	<include name="**/ra/*.class" />
            	<include name="**/util/*.class" />
         	</classes>
        </war>
    </target>
    
    <!-- =================================================================== -->
    <!-- Build Javadoc part                                                  -->
    <!-- =================================================================== -->
    <target name="javadoc" depends="">
        <mkdir dir="${apidoc}" />
        <javadoc packagenames="org.ejbca.extra.*" maxmemory="256m" sourcepath="${src.java}" destdir="${apidoc}" extdirs="${lib}" author="true" version="true" use="true" windowtitle="EJBCA API" bottom="Copyright &#169; 2005 PrimeKey Solutions AB.">
        </javadoc>
    </target>
	
    <!-- =================================================================== -->
    <!-- Build SCEPRA hibernate configuration package                       -->
    <!-- =================================================================== -->
    <target name="sceprajbosshibernate" depends="scepcompile">
        <mkdir dir="${sceprajbosshibernate.build}" />
    	<mkdir dir="${sceprajbosshibernate.build}/META-INF" />
        <copy todir="${sceprajbosshibernate.build}/META-INF">
            <fileset dir="${src}/appserver/jboss">
                <include name="hibernate-service.xml" />
            </fileset>
        </copy>
    	<mkdir dir="${sceprajbosshibernate.build}/org/ejbca/extra/db" />
        <copy todir="${sceprajbosshibernate.build}/org/ejbca/extra/db">
            <fileset dir="${src.db}">
                <include name="Message.hbm.xml" />
            </fileset>
        </copy>
        <copy todir="${sceprajbosshibernate.build}/org/ejbca/extra/db">
            <fileset dir="${build}/org/ejbca/extra/db">
                <include name="*.class" />
            </fileset>
        </copy>
        <copy todir="${sceprajbosshibernate.build}">
            <fileset dir="${lib}">
               <include name="commons-collections-2.1.1.jar" />
            </fileset>
        </copy>    	
        <jar basedir="${sceprajbosshibernate.build}" jarfile="${sceprajbosshibernatehar}">
            <manifest>
                <attribute name="Class-Path" value="" />
            </manifest>
        </jar>
    </target>
	

    <!-- ======================================================================= -->
    <!-- Deploy SCEP RA Server war to JBoss                                               -->
    <!-- ======================================================================= -->
    <target name="deployscepraserver" depends="scepraserver" description="Deploy the SCEP ra server war application">
        <antcall target="j2ee:deployscepraserver" />
    </target>

	
    <!-- ======================================================================= -->
    <!-- Below are targets for automated tests                                   -->
    <!-- ======================================================================= -->
    <target name="test:runweb" depends="test:compile,j2ee:assert-run" description="run JUnit web testcases for SCEP">
        <delete dir="${test.dir}/web/reports" />
        <mkdir dir="${test.dir}/web/reports/html" />
        <junit printsummary="yes" haltonfailure="no">
			<sysproperty key="testtype" value="WEB"/>
            <classpath>
                <path refid="test.compile.classpath" />
                <path location="${test.dir}" />
            </classpath>
            <formatter type="xml" />
        	<!-- we must use fork=yes or the BC JCE won't be authenticated due to some problem with ant classloading -->
            <batchtest fork="yes" todir="${test.dir}/web/reports">
                <fileset dir="${test.dir}">
                    <include name="**/ra/ProtocolScepHttpTest*" />
                </fileset>
            </batchtest>
        </junit>
        <junitreport todir="${test.dir}/web/reports">
            <fileset dir="${test.dir}/web/reports">
                <include name="TEST-*.xml" />
            </fileset>
            <report format="frames" todir="${test.dir}/web/reports/html" />
        </junitreport>
    </target>

	
</project>