<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE ejb-jar PUBLIC
	"-//Sun Microsystems, Inc.//DTD Enterprise JavaBeans 2.0//EN"
	"http://java.sun.com/dtd/ejb-jar_2_0.dtd">
<ejb-jar>

 <description></description>
 <display-name>Authorization Module</display-name>

 <enterprise-beans>

   <session>
     <description>
         Session bean handling interface with ra authorization, uses entity beans AvailableAccessRules,
         AdminGroupData
     </description>
     <ejb-name>AuthorizationSession</ejb-name>
     <home>se.anatom.ejbca.authorization.IAuthorizationSessionHome</home>
     <remote>se.anatom.ejbca.authorization.IAuthorizationSessionRemote</remote>
     <local-home>se.anatom.ejbca.authorization.IAuthorizationSessionLocalHome</local-home>
     <local>se.anatom.ejbca.authorization.IAuthorizationSessionLocal</local>
     <ejb-class>se.anatom.ejbca.authorization.LocalAuthorizationSessionBean</ejb-class>
     <session-type>Stateless</session-type>
     <transaction-type>Container</transaction-type>
     <env-entry>
        <description>JDBC datasource to be used</description>
        <env-entry-name>DataSource</env-entry-name>
        <env-entry-type>java.lang.String</env-entry-type>
        <env-entry-value>java:/DefaultDS</env-entry-value>
     </env-entry>
     <env-entry>
        <description>Custom Available Access Rules, use ';' to separate multiple accessrules</description>
        <env-entry-name>CustomAvailableAccessRules</env-entry-name>
        <env-entry-type>java.lang.String</env-entry-type>
        <env-entry-value></env-entry-value>
     </env-entry>     
     <ejb-local-ref>
        <description>The Log session bean</description>
        <ejb-ref-name>ejb/LogSessionLocal</ejb-ref-name>
        <ejb-ref-type>Session</ejb-ref-type>
        <local-home>se.anatom.ejbca.log.ILogSessionLocalHome</local-home>
        <local>se.anatom.ejbca.log.ILogSessionLocal</local>
        <ejb-link>LogSession</ejb-link>
     </ejb-local-ref>
     <ejb-local-ref>
        <description>The RA Admin session bean</description>
        <ejb-ref-name>ejb/RaAdminSessionLocal</ejb-ref-name>
        <ejb-ref-type>Session</ejb-ref-type>
        <local-home>se.anatom.ejbca.ra.raadmin.IRaAdminSessionLocalHome</local-home>
        <local>se.anatom.ejbca.ra.raadmin.IRaAdminSessionLocal</local>
        <ejb-link>RaAdminSession</ejb-link>
     </ejb-local-ref>     
     <ejb-local-ref>
        <description>The CAAdmin Session bean</description>
        <ejb-ref-name>ejb/CAAdminSessionLocal</ejb-ref-name>
        <ejb-ref-type>Session</ejb-ref-type>
        <local-home>se.anatom.ejbca.ca.caadmin.ICAAdminSessionLocalHome</local-home>
        <local>se.anatom.ejbca.ca.sign.ICAAdminSessionLocal</local>
        <ejb-link>CAAdminSession</ejb-link>
     </ejb-local-ref>     
     <ejb-local-ref>
        <description>The Certificate Store Session bean</description>
        <ejb-ref-name>ejb/CertificateStoreSessionLocal</ejb-ref-name>
        <ejb-ref-type>Session</ejb-ref-type>
        <local-home>se.anatom.ejbca.ca.store.ICertificateStoreSessionLocalHome</local-home>
        <local>se.anatom.ejbca.ca.sore.ICertificateStoreSessionLocal</local>
        <ejb-link>CertificateStoreSession</ejb-link>
     </ejb-local-ref>     
     <ejb-local-ref>
        <description>Authorization Tree Update Bean</description>
        <ejb-ref-name>ejb/AuthorizationTreeUpdateDataLocal</ejb-ref-name>
        <ejb-ref-type>Entity</ejb-ref-type>
        <local-home>se.anatom.ejbca.authorization.AuthorizationTreeUpdateDataLocalHome</local-home>
        <local>se.anatom.ejbca.authorization.AuthorizationTreeUpdateDataLocal</local>
        <ejb-link>AuthorizationTreeUpdateData</ejb-link>
     </ejb-local-ref>
     <ejb-local-ref>
        <description>Admin Groups</description>
        <ejb-ref-name>ejb/AdminGroupDataLocal</ejb-ref-name>
        <ejb-ref-type>Entity</ejb-ref-type>
        <local-home>se.anatom.ejbca.authorization.AdminGroupDataLocalHome</local-home>
        <local>se.anatom.ejbca.authorization.AdminGroupDataLocal</local>
        <ejb-link>AdminGroupData</ejb-link>
     </ejb-local-ref>
     <ejb-local-ref>
        <description>Access Rules</description>
        <ejb-ref-name>ejb/AccessRulesDataLocal</ejb-ref-name>
        <ejb-ref-type>Entity</ejb-ref-type>
        <local-home>se.anatom.ejbca.authorization.AccessRulesDataLocalHome</local-home>
        <local>se.anatom.ejbca.authorization.AccessRulesDataLocal</local>
        <ejb-link>AccessRulesData</ejb-link>
     </ejb-local-ref>
     <ejb-local-ref>
        <description>Admin Entities</description>
        <ejb-ref-name>ejb/AdminEntityDataLocal</ejb-ref-name>
        <ejb-ref-type>Entity</ejb-ref-type>
        <local-home>se.anatom.ejbca.authorization.AdminEntityDataLocalHome</local-home>
        <local>se.anatom.ejbca.authorization.AdminEntityDataLocal</local>
        <ejb-link>AdminEntityData</ejb-link>
     </ejb-local-ref>
     <security-identity>
        <description></description>
        <run-as>
        <description></description>
            <role-name>InternalUser</role-name>
        </run-as>
      </security-identity>
   </session>


   <entity>
      <description>
            This enterprise bean entity represents an authorization usergroup.
      </description>
      <ejb-name>AdminGroupData</ejb-name>
      <local-home>se.anatom.ejbca.authorization.AdminGroupDataLocalHome</local-home>
      <local>se.anatom.ejbca.authorization.AdminGroupDataLocal</local>
      <ejb-class>se.anatom.ejbca.authorization.AdminGroupDataBean</ejb-class>
      <persistence-type>Container</persistence-type>
      <prim-key-class>java.lang.Integer</prim-key-class>      
      <reentrant>False</reentrant>
      <cmp-version>2.x</cmp-version>
      <abstract-schema-name>AdminGroupDataBean</abstract-schema-name>
      <cmp-field><field-name>pK</field-name></cmp-field>
      <cmp-field><field-name>adminGroupName</field-name></cmp-field>
      <cmp-field><field-name>cAId</field-name></cmp-field>
      <primkey-field>pK</primkey-field>      
      <ejb-local-ref>
        <ejb-ref-name>ejb/AdminEntityDataLocal</ejb-ref-name>
        <ejb-ref-type>Entity</ejb-ref-type>
        <local-home>se.anatom.ejbca.authorization.AdminEntityDataLocalHome</local-home>
        <local>se.anatom.ejbca.authorization.AdminEntityDataLocal</local>
        <ejb-link>AdminEntityData</ejb-link>
      </ejb-local-ref>
      <ejb-local-ref>
        <ejb-ref-name>ejb/AccessRulesDataLocal</ejb-ref-name>
        <ejb-ref-type>Entity</ejb-ref-type>
        <local-home>se.anatom.ejbca.authorization.AccessRulesDataLocalHome</local-home>
        <local>se.anatom.ejbca.authorization.AccessRulesDataLocal</local>
        <ejb-link>AccessRulesData</ejb-link>
      </ejb-local-ref>
      <query>
        <query-method>
          <method-name>findByGroupNameAndCAId</method-name>
          <method-params>
      	    <method-param>java.lang.String</method-param>
      	    <method-param>int</method-param>            
          </method-params>  
        </query-method>
        <ejb-ql>
          <![CDATA[SELECT DISTINCT OBJECT(a) from AdminGroupDataBean a WHERE a.adminGroupName=?1 AND a.cAId=?2]]>
        </ejb-ql>
      </query>
      <query>
        <query-method>
          <method-name>findAll</method-name>
            <method-params></method-params>
        </query-method>
        <ejb-ql>
          <![CDATA[SELECT DISTINCT OBJECT(a) from AdminGroupDataBean a]]>
        </ejb-ql>
      </query>
   </entity>
   
   <entity>
      <description>
            This enterprise bean entity represents a user entity.
      </description>
      <ejb-name>AdminEntityData</ejb-name>
      <local-home>se.anatom.ejbca.authorization.AdminEntityDataLocalHome</local-home>
      <local>se.anatom.ejbca.authorization.AdminEntityDataLocal</local>
      <ejb-class>se.anatom.ejbca.authorization.AdminEntityDataBean</ejb-class>
      <persistence-type>Container</persistence-type>
      <prim-key-class>se.anatom.ejbca.authorization.AdminEntityPK</prim-key-class>
      <reentrant>False</reentrant>
      <cmp-version>2.x</cmp-version>
      <abstract-schema-name>AdminEntityDataBean</abstract-schema-name>
      <cmp-field><field-name>pK</field-name></cmp-field>
      <cmp-field><field-name>matchWith</field-name></cmp-field>
      <cmp-field><field-name>matchType</field-name></cmp-field>
      <cmp-field><field-name>matchValue</field-name></cmp-field>
   </entity>
   <entity>
      <description>
            This enterprise bean entity represents an access rule.
      </description>
      <ejb-name>AccessRulesData</ejb-name>
      <local-home>se.anatom.ejbca.authorization.AccessRulesDataLocalHome</local-home>
      <local>se.anatom.ejbca.authorization.AccessRulesDataLocal</local>
      <ejb-class>se.anatom.ejbca.authorization.AccessRulesDataBean</ejb-class>
      <persistence-type>Container</persistence-type>
      <prim-key-class>se.anatom.ejbca.authorization.AccessRulesPK</prim-key-class>
      <reentrant>False</reentrant>
      <cmp-version>2.x</cmp-version>
      <abstract-schema-name>AccessRulesDataBean</abstract-schema-name>
      <cmp-field><field-name>pK</field-name></cmp-field>
      <cmp-field><field-name>accessRule</field-name></cmp-field>
      <cmp-field><field-name>rule</field-name></cmp-field>      
      <cmp-field><field-name>isRecursive</field-name></cmp-field>
   </entity>
   <entity>
      <description>
            The Authorization Tree Update Data Bean
      </description>
      <ejb-name>AuthorizationTreeUpdateData</ejb-name>
      <local-home>se.anatom.ejbca.authorization.AuthorizationTreeUpdateDataLocalHome</local-home>
      <local>se.anatom.ejbca.authorization.AuthorizationTreeUpdateDataLocal</local>
      <ejb-class>se.anatom.ejbca.authorization.AuthorizationTreeUpdateDataBean</ejb-class>
      <persistence-type>Container</persistence-type>
      <prim-key-class>java.lang.Integer</prim-key-class>
      <reentrant>False</reentrant>
      <cmp-version>2.x</cmp-version>
      <abstract-schema-name>AuthorizationTreeUpdateDataBean</abstract-schema-name>
      <cmp-field><field-name>pK</field-name></cmp-field>
      <cmp-field><field-name>authorizationTreeUpdateNumber</field-name></cmp-field>
      <primkey-field>pK</primkey-field>      
   </entity>
   
  </enterprise-beans>

  <relationships>
     <ejb-relation>
       <ejb-relation-name>AdminGroupDataToAdminEntities</ejb-relation-name>
       <ejb-relationship-role>
         <ejb-relationship-role-name>AdminGroupData</ejb-relationship-role-name>
         <multiplicity>One</multiplicity>
         <relationship-role-source>
           <ejb-name>AdminGroupData</ejb-name>
         </relationship-role-source>
         <cmr-field>
           <cmr-field-name>adminEntities</cmr-field-name>
           <cmr-field-type>java.util.Collection</cmr-field-type>
         </cmr-field>
       </ejb-relationship-role>
       <ejb-relationship-role>
         <ejb-relationship-role-name>AdminEntityData</ejb-relationship-role-name>
         <multiplicity>Many</multiplicity>
         <relationship-role-source>
           <ejb-name>AdminEntityData</ejb-name>
         </relationship-role-source>
       </ejb-relationship-role>
     </ejb-relation>

     <ejb-relation>
       <ejb-relation-name>AdminGroupDataToAccessRules</ejb-relation-name>
       <ejb-relationship-role>
         <ejb-relationship-role-name>AdminGroupData</ejb-relationship-role-name>
         <multiplicity>One</multiplicity>
         <relationship-role-source>
           <ejb-name>AdminGroupData</ejb-name>
         </relationship-role-source>
         <cmr-field>
           <cmr-field-name>accessRules</cmr-field-name>
           <cmr-field-type>java.util.Collection</cmr-field-type>
         </cmr-field>
       </ejb-relationship-role>
       <ejb-relationship-role>
         <ejb-relationship-role-name>AccessRulesData</ejb-relationship-role-name>
         <multiplicity>Many</multiplicity>
         <relationship-role-source>
           <ejb-name>AccessRulesData</ejb-name>
         </relationship-role-source>
       </ejb-relationship-role>
     </ejb-relation>
  </relationships>

  <assembly-descriptor>
   <security-role>
      <description>
         This role represents everyone
      </description>
     <role-name>everyone</role-name>
   </security-role>
   <security-role>
      <description>
         This role represents an internal process
      </description>
      <role-name>InternalUser</role-name>
    </security-role>

   <!--
       Method permissions define who can access a given method on a bean.
       Role name internalUser means that the bean methods should NOT be
       accessible from the outside.
       Role name everyone means that the bean methods can be accessible from
       the outside.
       NOTE! Security must be enabled in the container for these settings
       to have any real meaning.
   -->
   <method-permission>
     <role-name>InternalUser</role-name>
     <method>
         <ejb-name>AuthorizationSession</ejb-name>
         <method-name>*</method-name>
     </method>
     <method>
         <ejb-name>AdminGroupData</ejb-name>
         <method-name>*</method-name>
     </method>
     <method>
         <ejb-name>AdminEntityData</ejb-name>
         <method-name>*</method-name>
     </method>
     <method>
         <ejb-name>AccessRulesData</ejb-name>
         <method-name>*</method-name>
     </method>
     <method>
         <ejb-name>AuthorizationTreeUpdateData</ejb-name>
         <method-name>*</method-name>
     </method>
   </method-permission>

   <!--
       Transaction settings. Default setting i for *, which is overridden
       for methods with special transactional needs.
       Required is used for mission critical methods, which cannot collide.
       Supports is used for methods which only read data.
   -->
   <container-transaction>
     <method>
         <ejb-name>AuthorizationSession</ejb-name>
         <method-name>*</method-name>
     </method>
     <trans-attribute>Required</trans-attribute>
   </container-transaction>

    <container-transaction>
    <method>
         <ejb-name>AuthorizationSession</ejb-name>
         <method-name>isAuthorized</method-name>
     </method>
     <method>
         <ejb-name>AuthorizationSession</ejb-name>
         <method-name>isAuthorizedNoLog</method-name>
     </method>
     <method>
         <ejb-name>AuthorizationSession</ejb-name>
         <method-name>isGroupAuthorized</method-name>
     </method>
     <method>
         <ejb-name>AuthorizationSession</ejb-name>
         <method-name>isGroupAuthorizedNoLog</method-name>
     </method>
     <method>
         <ejb-name>AuthorizationSession</ejb-name>
         <method-name>existsAdministratorInGroup</method-name>
     </method>
     <method>
         <ejb-name>AuthorizationSession</ejb-name>
         <method-name>authenticate</method-name>
     </method>
     <method>
         <ejb-name>AuthorizationSession</ejb-name>
         <method-name>getAdminGroup</method-name>
     </method>
     <method>
         <ejb-name>AuthorizationSession</ejb-name>
         <method-name>getAuthorizedAdminGroupNames</method-name>
     </method>     
     <method>
         <ejb-name>AuthorizationSession</ejb-name>
         <method-name>getAuthorizedAvailableAccessRules</method-name>
     </method>  
     <method>
         <ejb-name>AuthorizationSession</ejb-name>
         <method-name>getAuthorizedCAIds</method-name>
     </method>  
     <method>
         <ejb-name>AuthorizationSession</ejb-name>
         <method-name>getAuthorizedEndEntityProfileIds</method-name>
     </method>               
     <method>
         <ejb-name>AuthorizationSession</ejb-name>
         <method-name>existsEndEntityProfileInRules</method-name>
     </method>
     <method>
         <ejb-name>AuthorizationSession</ejb-name>
         <method-name>existsCAInRules</method-name>
     </method> 
     <trans-attribute>Supports</trans-attribute>
   </container-transaction>

 </assembly-descriptor>
</ejb-jar>
