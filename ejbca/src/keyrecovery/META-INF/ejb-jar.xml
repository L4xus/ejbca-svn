<?xml version="1.0"?>
<!DOCTYPE ejb-jar PUBLIC
	"-//Sun Microsystems, Inc.//DTD Enterprise JavaBeans 2.0//EN"
	"http://java.sun.com/dtd/ejb-jar_2_0.dtd">
<ejb-jar>

 <description></description>
 <display-name>Key Recovery Component</display-name>

 <enterprise-beans>
    <session>
     <description>
         Session bean handling Key Recovery data.
     </description>
     <ejb-name>KeyRecoverySession</ejb-name>
     <home>se.anatom.ejbca.keyrecovery.IKeyRecoverySessionHome</home>
     <remote>se.anatom.ejbca.keyrecovery.IKeyRecoverySessionRemote</remote>
     <local-home>se.anatom.ejbca.keyrecovery.IKeyRecoverySessionLocalHome</local-home>
     <local>se.anatom.ejbca.keyrecovery.IKeyRecoverySessionLocal</local>     
     <ejb-class>se.anatom.ejbca.keyrecovery.LocalKeyRecoverySessionBean</ejb-class>
     <session-type>Stateless</session-type>
     <transaction-type>Container</transaction-type>

     <env-entry>
        <description>JDBC datasource to be used</description>
        <env-entry-name>DataSource</env-entry-name>
        <env-entry-type>java.lang.String</env-entry-type>
        <env-entry-value>java:/DefaultDS</env-entry-value>
     </env-entry>

     <ejb-local-ref>
        <description>The key recovery data entity bean</description>
        <ejb-ref-name>ejb/KeyRecoveryDataLocal</ejb-ref-name>
        <ejb-ref-type>Entity</ejb-ref-type>
        <local-home>se.anatom.ejbca.keyrecovery.KeyRecoveryDataLocalHome</local-home>
        <local>se.anatom.ejbca.keyrecovery.KeyRecoveryDataLocal</local>
        <ejb-link>KeyRecoveryData</ejb-link>
     </ejb-local-ref>

     <ejb-local-ref>
        <description>The Sign Session Bean</description>
        <ejb-ref-name>ejb/RSASignSession</ejb-ref-name>
        <ejb-ref-type>Session</ejb-ref-type>
        <local-home>se.anatom.ejbca.ca.sign.ISignSessionLocalHome</local-home>
        <local>se.anatom.ejbca.ca.sign.ISignSessionLocal</local>
        <ejb-link>RSASignSession</ejb-link>
     </ejb-local-ref> 
     <ejb-local-ref>
        <description>The Certificate Store session bean</description>
        <ejb-ref-name>ejb/CertificateStoreSession</ejb-ref-name>
        <ejb-ref-type>Session</ejb-ref-type>
        <local-home>se.anatom.ejbca.ca.store.ICertificateStoreSessionLocalHome</local-home>
        <local>se.anatom.ejbca.ca.store.ICertificateStoreSessionLocal</local>
        <ejb-link>CertificateStoreSession</ejb-link>
     </ejb-local-ref>                    

     <ejb-local-ref>
        <description>The log session bean</description>
        <ejb-ref-name>ejb/LogSessionLocal</ejb-ref-name>
        <ejb-ref-type>Session</ejb-ref-type>
        <local-home>se.anatom.ejbca.log.ILogSessionLocalHome</local-home>
        <local>se.anatom.ejbca.log.ILogSessionLocal</local>
        <ejb-link>LogSession</ejb-link>
     </ejb-local-ref>

   </session> 
   
   <entity>
      <description>
            This enterprise bean entity represents data needed for key recovery.
      </description>
      <ejb-name>KeyRecoveryData</ejb-name>
      <local-home>se.anatom.ejbca.keyrecovery.KeyRecoveryDataLocalHome</local-home>
      <local>se.anatom.ejbca.keyrecovery.KeyRecoveryDataLocal</local>
      <ejb-class>se.anatom.ejbca.keyrecovery.KeyRecoveryDataBean</ejb-class>
      <persistence-type>Container</persistence-type>
      <prim-key-class>se.anatom.ejbca.keyrecovery.KeyRecoveryDataPK</prim-key-class>
      <reentrant>False</reentrant>
      <cmp-version>2.x</cmp-version>
      <abstract-schema-name>KeyRecoveryDataBean</abstract-schema-name>
      <cmp-field><field-name>certSN</field-name></cmp-field>
      <cmp-field><field-name>issuerDN</field-name></cmp-field>
      <cmp-field><field-name>username</field-name></cmp-field>
      <cmp-field><field-name>markedAsRecoverable</field-name></cmp-field>      
      <cmp-field><field-name>keyData</field-name></cmp-field>
      
      <query>
      	<query-method>
      	  <method-name>findByUsername</method-name>
      	  <method-params>
      	    <method-param>java.lang.String</method-param>
      	  </method-params>
      	</query-method>
	<ejb-ql>
	  <![CDATA[SELECT DISTINCT OBJECT(a) from KeyRecoveryDataBean a WHERE a.username=?1]]>
	</ejb-ql>
      </query>
      <query>
      	<query-method>
      	  <method-name>findByUserMark</method-name>
      	  <method-params>
      	    <method-param>java.lang.String</method-param>        
      	  </method-params>
      	</query-method>
	<ejb-ql>
	  <![CDATA[SELECT DISTINCT OBJECT(a) from KeyRecoveryDataBean a WHERE a.username=?1 AND a.markedAsRecoverable=TRUE]]>
	</ejb-ql>
      </query>    
   </entity>
  </enterprise-beans>
  
  <assembly-descriptor>
   <security-role>
      <description>
         This role represents everyone
      </description>
     <role-name>everyone</role-name>
   </security-role>
   <security-role>
      <description>
         This role represents an internal process
      </description>
      <role-name>InternalUser</role-name>
    </security-role>

   <!--
       Method permissions define who can access a given method on a bean.
       Role name internalUser means that the bean methods should NOT be
       accessible from the outside.
       Role name everyone means that the bean methods can be accessible from
       the outside.
       NOTE! Security must be enabled in the container for these settings
       to have any real meaning.
   -->
   <method-permission>
     <role-name>InternalUser</role-name>
     <method>
         <ejb-name>KeyRecoverySession</ejb-name>
         <method-name>*</method-name>
     </method> 
     <method>
         <ejb-name>KeyRecoveryData</ejb-name>
         <method-name>*</method-name>
     </method>          
   </method-permission>

   <!--
       Transaction settings. Default setting i for *, which is overridden
       for methods with special transactional needs.
       Required is used for mission critical methods, which cannot collide.
       Supports is used for methods which only read data.
   -->
   <container-transaction>
      <method>
         <ejb-name>KeyRecoverySession</ejb-name>
         <method-name>*</method-name>
     </method>       
     <trans-attribute>Required</trans-attribute>
   </container-transaction>

    <container-transaction>
    <method>
         <ejb-name>KeyRecoverySession</ejb-name>
         <method-name>isUserMarked</method-name>
     </method>  
    <method>
         <ejb-name>KeyRecoverySession</ejb-name>
         <method-name>existsKeys</method-name>
     </method>  
     <trans-attribute>Supports</trans-attribute>
   </container-transaction>

 </assembly-descriptor>
</ejb-jar>

