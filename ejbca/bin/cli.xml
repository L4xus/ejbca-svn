<project name="cli" default="ejbca:install" basedir="." xmlns:ejbca="ejbca">

    <!-- Set this to false if no prompting for requested CA, 
         and Web configuration should be made
    -->
    <property name="ejbca.prompt" value="true"/>

    <property name="ejbca.home" location=".."/>
    <property environment="env"/>

    <property file="${user.home}/${app.name}.properties"/>
    <property file="${ejbca.home}/${app.name}.properties"/>
    <!-- this sucks because we have a dependency with JBoss just for the jndi provider -->
    <property name="jboss.home" value="${env.JBOSS_HOME}"/>
<!--    <property name="weblogic.home" value="${env.WEBLOGIC_HOME}"/> -->

    <property name="lib.dir" location="${ejbca.home}/lib"/>

    <path id="classpath">
         <!-- need to pickup jndi.properties and log4j.properties -->
        <pathelement path="${ejbca.home}/bin"/>
        <pathelement path="${ejbca.home}/tmp/bin/classes"/>
        <fileset dir="${lib.dir}" includes="*.jar"/>
        <fileset dir="${jboss.home}/client" includes="*.jar"/>
<!--        <fileset dir="${weblogic.home}/server/lib" includes="weblogic.jar"/> -->
    </path>

<!--
    This is a transcript of the install.sh content to avoid platform specific problems
    Hopefully this will simplify maintenance and deployment but it needs more work.
-->

	<target name="check:bootstrapdone">
        <available file="${ejbca.home}/dist/${app.name}.ear" property="bootstrap.done"/>
        <fail unless="bootstrap.done" message="Missing EJBCA_HOME/dist/${app.name}.ear. You must do 'ant bootstrap' to build the ${app.name}.ear file." />
	</target>

    <target name="ejbca:noprompt" unless="ejbca.prompt">
        <property name="ca.name" value="AdminCA1"/>
        <property name="ca.dn" value="CN=AdminCA1,O=${app.name.cap} Sample,C=SE"/>
        <property name="ca.keysize" value="2048"/>
        <property name="ca.keytype" value="RSA"/>
        <property name="ca.validity" value="3650"/>
        <property name="ca.policy" value="null"/>
        <property name="httpsserver.hostname" value="localhost"/>
        <property name="httpsserver.dn" value="CN=localhost,O=${app.name.cap} Sample,C=SE"/>
		<property name="superadmin.password" value="ejbca"/>
        <property name="java.trustpassword" value="changeit"/>
    </target>

    <target name="ejbca:prompt" if="ejbca.prompt">
        <input message="Please enter the CA name (default: AdminCA1) ?" addproperty="ca.name" defaultvalue="AdminCA1"/>
        <input message="Please enter the CA dn (default: CN=AdminCA1,O=${app.name.cap} Sample,C=SE) ?" addproperty="ca.dn" defaultvalue="CN=AdminCA1,O=${app.name.cap} Sample,C=SE"/>
        <input message="Please enter the CA key size (default: 2048) ?" addproperty="ca.keysize" defaultvalue="2048" />
        <input message="Please enter the CA key type (default: RSA) ?" addproperty="ca.keytype" defaultvalue="RSA" />
        <input message="Please enter the CA validity in days (default: 3650) ?" addproperty="ca.validity" defaultvalue="3650"/>
        <input message="Please enter the CA policy id (default, no policy) ?" addproperty="ca.policy" defaultvalue="null"/>
        <input message="Please enter the server httpsserver.hostname (default 'localhost') ?" addproperty="httpsserver.hostname" defaultvalue="localhost"/>
        <input message="Please enter the server dn (default: CN=localhost,O=${app.name.cap} Sample,C=SE) ?" addproperty="httpsserver.dn" defaultvalue="CN=localhost,O=${app.name.cap} Sample,C=SE"/>
        <input message="Please enter the superadmin password (default: ${app.name}) ?" addproperty="superadmin.password" defaultvalue="${app.name}"/>
        <input message="Please enter the CA certificate password (default: changeit) ?" addproperty="java.trustpassword" defaultvalue="changeit"/>
    </target>

    <target name="ejbca:init" depends="ejbca:noprompt,ejbca:prompt">
        <echo>
------------------- CA Properties ----------------
ca.name             : ${ca.name}
ca.dn               : ${ca.dn}
ca.keysize          : ${ca.keysize}
ca.keytype          : ${ca.keytype}
ca.validity         : ${ca.validity}
ca.policy           : ${ca.policy}
httpsserver.hostname: ${httpsserver.hostname}
httpsserver.dn      : ${httpsserver.dn}
httpsserver.password: ${httpsserver.password}
superadmin.password : ${superadmin.password}
java.trustpassword  : ${java.trustpassword}
        </echo>
    </target>

	<target name="ejbca:javatruststore" description="Java trust store config">
        <echo message="Creating root certificate in DER format..."/>
	    <ejbca:cli name="ca" arg='getrootcert ${ca.name} ${java.io.tmpdir}/rootca.der -der'/>
	    <ejbca:keytool arg="-v -alias ${ca.name} -delete -keystore '${java.home}/lib/security/cacerts' -storepass ${java.trustpassword}"/>
	    <ejbca:keytool arg="-v -alias ${ca.name} -import -trustcacerts -file '${java.io.tmpdir}/rootca.der' -keystore '${java.home}/lib/security/cacerts' -storepass ${java.trustpassword} -noprompt"/>
	    <delete file="${java.io.tmpdir}/rootca.der"/>
	</target>

    <target name="ejbca:install" depends="check:bootstrapdone, ejbca:init" description="Install">
        <echo message="Initializing CA with ${ca.name} '${ca.dn}' ${ca.keysize} ${ca.keytype} ${ca.validity} ${ca.policy} ..."/>
        <ejbca:cli name="ca" arg='init ${ca.name} "${ca.dn}" ${ca.keysize} ${ca.keytype} ${ca.validity} ${ca.policy}'/>
        <antcall target="ejbca:adminweb"/>
    	<antcall target="ejbca:javatruststore"/>
    </target>

	<target name="ejbca:adminweb">
		<ejbca:cli name="setup" arg="setdefaultbaseurl ${httpsserver.hostname} ${app.name}"/>
		
		<ejbca:cli name="ra" arg='adduser tomcat ${httpsserver.password} "${httpsserver.dn}" null ${ca.name} null 1 JKS'/>
		<ejbca:cli name="ra" arg="setclearpwd tomcat ${httpsserver.password}"/>
		
		<ejbca:cli name="ra" arg='adduser superadmin ${superadmin.password} "CN=SuperAdmin" null ${ca.name} null 65 P12'/>
		<ejbca:cli name="ra" arg="setclearpwd superadmin ${superadmin.password}"/>
		
		<!--
		this does not work for some reason, if I'm not forking the VM, I'm wondering
		if it is not an issue with the Ant classloader
		For in ejbca.home in order to have the p12 directory as a child of it.
		-->
		<java dir="${ejbca.home}" fork="true" classname="org.ejbca.ui.cli.batch.BatchMakeP12" classpathref="classpath"/>
		
	</target>
    
	<target name="ejbca:cli" depends="ejbca:noprompt" description="Handy hook to run a command">
		<ejbca:cli name="${cli.name}" arg="${cli.args}"/>
	</target>

    
    <!--
    ==============================================================================
        macro definitions
    ==============================================================================
    -->
    <macrodef name="cli" uri="ejbca">
        <attribute name="name"/>
        <attribute name="arg"/>
        <sequential>
        <echo message="@{name} @{arg}"/>
        <java classname="org.ejbca.ui.cli.@{name}" classpathref="classpath">
            <arg line="@{arg}"/>
        </java>
        </sequential>
    </macrodef>

    <macrodef name="keytool" uri="ejbca">
        <attribute name="arg"/>
        <sequential>
        <exec executable="keytool">
            <arg line="@{arg}"/>
        </exec>
        </sequential>
    </macrodef>

</project>
