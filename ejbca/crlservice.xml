<?xml version="1.0"?>
<project name="crlservice" basedir=".">

	<!-- =================================================================== -->
    <!-- Build Jboss Specific Services                       -->
    <!-- =================================================================== -->
    <target name="createcrlservice" depends="compile">
        <path id="jbossservices.classpath">
            <pathelement location="${jboss.home}/lib/jboss-system.jar" />
            <pathelement location="${jboss.home}/lib/jboss-common.jar" />
            <pathelement location="${jboss.home}/lib/jboss-jmx.jar" />
        </path>
        <javac srcdir="${src.java}" extdirs="${lib}" destdir="${build}" debug="on" encoding="iso8859-1">
            <exclude name="**/CVS/**" />
            <include name="**/appserver/**/CRL*" />
            <include name="**/appserver/**/Scriptrunning*" />
            <exclude name="**/appserver/jboss/SigningDailyRollingFileAppender*" />
            <exclude name="**/appserver/jboss/RollingCalendar*" />
            <!-- appserver specific files are built separtely-->
            <classpath refid="jbossservices.classpath" />
            <classpath refid="compile.classpath" />
        </javac>

        <mkdir dir="${createcrlservice.build}" />
        <copy todir="${createcrlservice.build}">
            <fileset dir="${src}/appserver/jboss">
                <include name="crlcreate-service.xml" />
            </fileset>
        </copy>
        <copy todir="${createcrlservice.build}">
            <fileset dir="${build}">
                <include name="org/ejbca/appserver/jboss/CRLCreate*.class" />
                <include name="org/ejbca/core/ejb/ca/crl/ICreateCRL*.class" />
                <include name="org/ejbca/core/model/log/Admin.class" />
                <exclude name="se/anatom/ejbca/**/*Test*" />
            </fileset>
        </copy>
        <jar basedir="${createcrlservice.build}" jarfile="${createcrlservicejar}">
            <manifest>
                <attribute name="Class-Path" value="${jar.classpath}" />
            </manifest>
        </jar>
    </target>

    <!-- =================================================================== -->
    <!--Deploy Jboss Specific Services                       -->
    <!-- =================================================================== -->
    <target name="deploycreatecrlservice" depends="createcrlservice">
        <copy file="${createcrlservicejar}" tofile="${jboss.farm.dir}/createcrlservice.jar" verbose="true" />
    </target>
	
	<target name="crlserviceconditioncheck">
		<condition property="createcrlservices.enabled">
			<istrue value="${createcrl.service.enabled}"/>
		</condition>
	</target>
	
    <!-- =================================================================== -->
    <!--Deploy EJBCA with Jboss Specific Services inside the ear file.       -->
    <!-- =================================================================== -->
    <target name="buildwithcreatecrlservice" depends="crlserviceconditioncheck, createcrlservice, ca.ear" description="Deploys EJBCA with CRL creation service">    	
    	<echo>Including create CRL service</echo>
        <copy todir="${tmp}" overwrite="false">
        	<fileset dir="${eardd.src}">
        	   <include name="META-INF/jboss-app.xml" />
        	</fileset> 
    	</copy>
    	<replace file="${tmp}/META-INF/jboss-app.xml" token="!--@crlcreateservice.jar@-->" value="module>&lt;service>crlcreateservice.jar&lt;/service>&lt;/module>"/>
        <ear update="true" destfile="${caear}" > 
            <fileset dir="${tmp}">
                <include name="META-INF/jboss-app.xml" />
            </fileset>
            <fileset dir="${dist.dir}">
                <include name="${createcrlservice.name}" />
            </fileset>
		</ear>
    </target>

</project>
