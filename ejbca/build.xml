<?xml version="1.0"?>

<project name="ejbca" default="build" basedir=".">

  <!-- set global properties for this build -->
  <property name="src" value="./src"/>
  <property name="javasrc" value="${src}/java"/>
  <property name="lib" value="./lib"/>
  <property name="tmp" value="./tmp" />
  <property name="build" value="${tmp}/classes"/>
  <property name="dist"  value="./dist"/>
  <property name="apidoc" value="./doc/api"/>
  
  <property name="apply.src" value="${src}/publicweb/apply" />
  <property name="apply.build" value="${tmp}/publicweb/apply.war" />
  <property name="applyjar" value="${dist}/apply.war" />
  
  <property name="webdist.src" value="${src}/publicweb/webdist" />
  <property name="webdist.build" value="${tmp}/publicweb/webdist.war" />
  <property name="webdistjar" value="${dist}/webdist.war" />

  <property name="sampleauth.src" value="${src}/ca/sampleauth" />
  <property name="sampleauth.build" value="${tmp}/ca/sampleauth.war" />
  <property name="sampleauthjar" value="${dist}/sampleauth.war" />

  <property name="ca.src" value="${src}/ca/ca" />
  <property name="ca.build" value="${tmp}/ca/ca.jar" />
  <property name="cajar" value="${dist}/ca.jar" />

  <property name="log.src" value="${src}/log" />
  <property name="log.build" value="${tmp}/log.jar" />
  <property name="logjar" value="${dist}/log.jar" />  
  
  <property name="ra.src" value="${src}/ra" />
  <property name="ra.build" value="${tmp}/ra.jar" />
  <property name="rajar" value="${dist}/ra.jar" />
  
  <property name="adminweb.src" value="${src}/adminweb" />
  <property name="adminweb.build" value="${tmp}/adminweb.war" />
  <property name="adminwebjar" value="${dist}/adminweb.war" />  

  <property name="caear.src" value="${src}/ca/ear" />
  <property name="caear.earsrc" value="${caear.src}/ear" />
  <property name="caear.warsrc" value="${src}/publicweb/root" />
  <property name="caear.build" value="${tmp}/ca/ear" />
  <property name="caear.warbuild" value="${tmp}/publicweb/publicwebroot.war" />
  <property name="caear.earbuild" value="${tmp}/ca/ear/ear" />
  <property name="carootwar" value="${caear.earbuild}/publicwebroot.war" />
  <property name="caear" value="${dist}/ejbca-ca.ear" />

  <property name="caearnora.build" value="${tmp}/canora/ear" />
  <property name="caearnora.warbuild" value="${tmp}/canora/ear/publicwebroot.war" />
  <property name="caearnora.earbuild" value="${tmp}/canora/ear/ear" />
  <property name="canorarootwar" value="${caearnora.earbuild}/publicwebroot.war" />
  <property name="caearnora" value="${dist}/ejbca-canora.ear" />

  <!-- Jar with class files needed for administration, i.e. ca, ra, jobrunner -->
  <property name="adminjar.build" value="${tmp}/adminjar" />
  <property name="adminjar" value="./admin.jar" />


  <!-- =================================================================== -->
  <!-- Create the time stamp and build directory -->
  <!-- =================================================================== -->
  <target name="init">
    <!-- Create the time stamp -->
    <tstamp/>
    <!-- Create the build directory structure used by compile -->
    <mkdir dir="${build}"/>
    <mkdir dir="${dist}"/>
  </target>

  <!-- =================================================================== -->
  <!-- Clean ALL                                                           -->
  <!-- =================================================================== -->
  <target name="clean">
    <!-- Delete the ${build} and ${dist} directory trees -->
    <delete dir="${build}"/>
    <delete dir="${dist}"/>
    <delete dir="${tmp}"/>
    <delete dir="${apidoc}"/>
    <delete file="admin.jar"/>
    <delete>
        <fileset dir="${javasrc}" 
includes="**/*.class,**/*.log,**/.nbattrs,**/filesystem.attributes"/>
    </delete>
    
  </target>

  <!-- =================================================================== -->
  <!-- Build ALL                                                           -->
  <!-- =================================================================== -->
  <target name="build" depends="compile, apply.war, webdist.war, ca.jar, log.jar,
ca.ear, canora.ear, ra.jar, adminweb.war, admin.jar, sampleauth.war">
  </target>

  <!-- =================================================================== -->
  <!-- Compile java sources                                                -->
  <!-- =================================================================== -->
  <target name="compile" depends="init">
    <!-- Compile the java code from ${javasrc} into ${build} -->
    <javac srcdir="${javasrc}" extdirs="${lib}" destdir="${build}" debug="on" >
        <exclude name="**/CVS/**"/>    
        <include name="**/*.java"/>
    </javac>
    <copy todir="${javasrc}">
        <fileset dir="${build}">
                <include name="**/*.class"/>
        </fileset>
    </copy> 

  </target>

  <!-- =================================================================== -->
  <!-- Build apply part                                                    -->
  <!-- =================================================================== -->
  <target name="apply.war" depends="compile">
    <mkdir    dir="${apply.build}"/>
    <copy todir="${apply.build}">
        <fileset dir="${apply.src}"> 
                <include name="**/*"/>
        </fileset>
    </copy>
    <copy todir="${apply.build}/WEB-INF/classes">
        <fileset dir="${build}">
                <include name="se/anatom/ejbca/apply/**/*.class"/>
                <include name="se/anatom/ejbca/ca/sign/**/ISign*.class"/>
                <include name="se/anatom/ejbca/util/**/Base64*.class"/>
                <include name="se/anatom/ejbca/util/**/CertTools*.class"/>
                <include name="se/anatom/ejbca/util/**/FileTools*.class"/>
                <include name="se/anatom/ejbca/exception/**/*.class"/>
                <include name="se/anatom/ejbca/ca/exception/**/*.class"/>
                <include name="se/anatom/ejbca/log/Admin.class"/>                
                <exclude name="se/anatom/ejbca/**/*Test*"/>
        </fileset>
    </copy>
  
    <!-- Jar the apply.war package together -->
    <jar basedir="${apply.build}" jarfile="${applyjar}"/>    
  </target>
  
  <!-- =================================================================== -->
  <!-- Build sampleauth part                                                   
 -->
  <!-- =================================================================== -->
  <target name="sampleauth.war" depends="compile">
    <mkdir    dir="${sampleauth.build}"/>
    <copy todir="${sampleauth.build}">
        <fileset dir="${sampleauth.src}"> 
                <include name="**/*"/>
        </fileset>
    </copy>
    <copy todir="${sampleauth.build}/WEB-INF/classes">
        <fileset dir="${build}">
                <include name="se/anatom/ejbca/samples/AuthResult*.class"/>
                <include name="se/anatom/ejbca/samples/RemoteVerify*.class"/>
                <include name="se/anatom/ejbca/exception/**/*.class"/>
                <include name="se/anatom/ejbca/ca/exception/**/*.class"/>
                <include name="se/anatom/ejbca/log/Admin.class"/>                 
                <exclude name="se/anatom/ejbca/**/*Test*"/>
        </fileset>
    </copy>
    <copy todir="${sampleauth.build}/WEB-INF/lib">
        <fileset dir="${lib}">
                <include name=""/>
        </fileset>
    </copy>
  
    <!-- Jar the sampleauth.war package together -->
    <jar basedir="${sampleauth.build}" jarfile="${sampleauthjar}"/>    
  </target>

  <!-- =================================================================== -->
  <!-- Build ca part                                                    -->
  <!-- =================================================================== -->
  <target name="ca.jar" depends="compile">
    <mkdir    dir="${ca.build}"/>
    <copy todir="${ca.build}">
        <fileset dir="${ca.src}"> 
                <include name="**/*"/>
                <exclude name="keyStore*/*"/>
        </fileset>
    </copy>
    <copy todir="${ca.build}">
        <fileset dir="${build}">
                <include name="se/anatom/ejbca/**/*.class"/>
                <exclude name="se/anatom/ejbca/**/*Test*"/>
        </fileset>
    </copy>
    
    <!-- Jar the ca.jar package together -->
    <jar basedir="${ca.build}" jarfile="${cajar}"/>    
  </target>

  <!-- =================================================================== -->
  <!-- Build log part                                                    -->
  <!-- =================================================================== -->
  <target name="log.jar" depends="compile">
    <mkdir    dir="${log.build}"/>
    <copy todir="${log.build}">
        <fileset dir="${log.src}"> 
                <include name="**/*"/>
        </fileset>
    </copy>
    <copy todir="${log.build}">
        <fileset dir="${build}">
                <include name="se/anatom/ejbca/log/*.class"/>
                <include name="se/anatom/ejbca/util/query/*.class"/>                
                <exclude name="se/anatom/ejbca/**/*Test*"/>
        </fileset>
    </copy>
    
    <!-- Jar the ca.jar package together -->
    <jar basedir="${log.build}" jarfile="${logjar}"/>    
  </target>  

  <!-- =================================================================== -->
  <!-- Build ra part                                                    -->
  <!-- =================================================================== -->
  <target name="ra.jar" depends="compile">
    <mkdir    dir="${ra.build}"/>
    <copy todir="${ra.build}">
        <fileset dir="${ra.src}"> 
                <exclude name="**web/raadmin/**"/>
                <include name="**/*"/>
        </fileset>
    </copy>
    <copy todir="${ra.build}">
        <fileset dir="${build}">
                <include name="se/anatom/ejbca/ra/**/*.class"/>            
                <include name="se/anatom/ejbca/*.class"/>
                <include name="se/anatom/ejbca/util/**/*.class"/>
                <include name="se/anatom/ejbca/util/query/*.class"/>   
                <include name="se/anatom/ejbca/log/Admin.class"/>                              
                <exclude name="se/anatom/ejbca/**/*Test*"/>           
        </fileset>
    </copy>
    
    <!-- Jar the ra.jar package together -->
    <jar basedir="${ra.build}" jarfile="${rajar}"/>    
  </target>

  <!-- =================================================================== -->
  <!-- Build webdist part                                                  -->
  <!-- =================================================================== -->
  <target name="webdist.war" depends="compile">
    <mkdir    dir="${webdist.build}"/>
    <copy todir="${webdist.build}">
        <fileset dir="${webdist.src}"> 
                <include name="**/**"/>
        </fileset>
    </copy>
    <copy todir="${webdist.build}/WEB-INF/classes">
        <fileset dir="${build}">
                <include name="se/anatom/ejbca/webdist/*.class"/>
                <include name="se/anatom/ejbca/ca/store/ICertificateStore*.class"/>
                <include name="se/anatom/ejbca/ca/store/certificatetypes/*.class"/>                
                <include name="se/anatom/ejbca/ca/store/IPublisher*.class"/>
                <include name="se/anatom/ejbca/ca/sign/ISign*.class"/>
                <include name="se/anatom/ejbca/ca/crl/**/RevokedCertInfo*.class"/>
                <include name="se/anatom/ejbca/util/**/Base64*.class"/>
                <include name="se/anatom/ejbca/util/**/CertTools*.class"/>
                <include name="se/anatom/ejbca/util/**/Hex*.class"/>
                <include name="se/anatom/ejbca/exception/**/*.class"/>
                <include name="se/anatom/ejbca/ca/exception/**/*.class"/>
                <include name="se/anatom/ejbca/log/Admin.class"/>                 
                <exclude name="se/anatom/ejbca/**/*Test*"/>
        </fileset>
    </copy>
  
    <!-- Jar the webdist.war package together -->
    <jar basedir="${webdist.build}" jarfile="${webdistjar}"/>    
  </target>
  
  <!-- =================================================================== -->
  <!-- Build admin web part                                              -->
  <!-- =================================================================== -->
  <target name="adminweb.war" depends="compile">
    <mkdir    dir="${adminweb.build}"/>
    <copy todir="${adminweb.build}">
        <fileset dir="${adminweb.src}"> 
                <include name="**/**"/>
        </fileset>
    </copy>
    <copy todir="${adminweb.build}/WEB-INF/classes">
        <fileset dir="${build}">
                <include name="se/anatom/ejbca/webdist/**/*.class"/>
                <include name="se/anatom/ejbca/ca/store/CertificateData*.class"/>                
                <include name="se/anatom/ejbca/ca/store/ICertificateStore*.class"/>         
                <include name="se/anatom/ejbca/ca/store/certificateprofiles/*.class"/>                        
                <include name="se/anatom/ejbca/ra/*.class"/>
                <include name="se/anatom/ejbca/ra/authorization/*.class"/>      
                <include name="se/anatom/ejbca/ra/raadmin/*.class"/>
                <include name="se/anatom/ejbca/ca/store/IPublisher*.class"/>
                <include name="se/anatom/ejbca/ca/sign/ISignSession*.class"/>
                <include name="se/anatom/ejbca/ca/crl/**/RevokedCertInfo*.class"/>
                <include name="se/anatom/ejbca/util/*.class"/>
                <include name="se/anatom/ejbca/util/query/*.class"/>                
                <include name="se/anatom/ejbca/exception/**/*.class"/>
                <include name="se/anatom/ejbca/ca/exception/**/*.class"/>           
                <include name="se/anatom/ejbca/log/Admin.class"/>                 
                <exclude name="se/anatom/ejbca/**/*Test*"/>
        </fileset>
    </copy>
    <copy todir="${adminweb.build}/WEB-INF/lib">
        <fileset dir="${lib}">
                <include name="regexp1_0_0.jar"/>
        </fileset>
    </copy>     
    <!-- Jar the webdist.war package together -->
    <jar basedir="${adminweb.build}" jarfile="${adminwebjar}"/>    
  </target>

  <!-- =================================================================== -->
  <!-- Build admin jar                                                     -->
  <!-- =================================================================== -->
  <target name="admin.jar" depends="compile">
    <mkdir dir="${adminjar.build}"/>
     <copy todir="${adminjar.build}">
        <fileset dir="${build}">
               <include name="se/anatom/ejbca/IJobRunner*.class"/>
                <include name="se/anatom/ejbca/SecConst*.class"/>
                <include name="se/anatom/ejbca/util/*.class"/> 
                <include name="se/anatom/ejbca/util/query/*.class"/>                
                <include name="se/anatom/ejbca/admin/*.class"/>
                <include name="se/anatom/ejbca/batch/*.class"/>
                <include name="se/anatom/ejbca/ca/store/ICertificateStore*.class"/>
                <include name="se/anatom/ejbca/ca/store/certificateprofiles/*.class"/>                
                <include name="se/anatom/ejbca/ca/store/IPublisher*.class"/>
                <include name="se/anatom/ejbca/ca/sign/ISignSession*.class"/>
                <include name="se/anatom/ejbca/ca/crl/RevokedCertInfo*.class"/>
                <include name="se/anatom/ejbca/ca/store/CertificateData*.class"/>
                <include name="se/anatom/ejbca/ca/store/ICertificateStore*.class"/> 
                <include name="se/anatom/ejbca/ra/*.class"/> 
                <include name="se/anatom/ejbca/exception/**/*.class"/>
                <include name="se/anatom/ejbca/ca/exception/**/*.class"/> 
                <include name="se/anatom/ejbca/ra/raadmin/AdminPreference.class"/>   
                <include name="se/anatom/ejbca/ra/raadmin/UserDoesntFullfillEndEntityProfile.class"/>   
                <include name="se/anatom/ejbca/ra/raadmin/IRaAdminSessionHome.class"/>   
                <include name="se/anatom/ejbca/ra/raadmin/IRaAdminSessionRemote.class"/>
                <include name="se/anatom/ejbca/ra/raadmin/EndEntityProfile.class"/>                                                 
                <include name="se/anatom/ejbca/ra/authorization/*Exception.class"/>
                <include name="se/anatom/ejbca/ra/authorization/UserEntity.class"/>  
                <include name="se/anatom/ejbca/ra/authorization/AdminInformation.class"/>      
                <include name="se/anatom/ejbca/log/Admin.class"/>                                                                                                                                                                                                 
                <include name="se/anatom/ejbca/protocol/RequestMessage.class"/>                                                                                                                                                                                                 
                <include name="se/anatom/ejbca/protocol/PKCS10RequestMessage.class"/>                                                                                                                                                                                                 
                <exclude name="se/anatom/ejbca/**/*Test*"/> 
       </fileset>
      </copy>
    <!-- Jar the admin.jar package together -->
    <jar basedir="${adminjar.build}" jarfile="${adminjar}"/>    
  </target>

  <!-- =================================================================== -->
  <!-- Build CA-ear                                                        -->
  <!-- =================================================================== -->
  <target name="ca.ear" depends="apply.war, webdist.war, ca.jar, ra.jar, adminweb.war, log.jar">
    <mkdir dir="${caear.build}"/>
    <copy todir="${caear.earbuild}">
        <fileset dir="${caear.earsrc}"> 
                <include name="**/*"/>
                <exclude name="META-INF/application-nora.xml"/>
        </fileset>
    </copy>
    <copy todir="${caear.warbuild}">
        <fileset dir="${caear.warsrc}"> 
                <include name="**/*"/>
        </fileset>
    </copy>
    
    <!-- Jar the ROOT war together -->
    <jar basedir="${caear.warbuild}" jarfile="${carootwar}"/>    

    <copy todir="${caear.earbuild}">
        <fileset dir="${dist}">
                <include name="webdist.war"/>
                <include name="apply.war"/>
                <include name="ca.jar"/>
                <include name="ra.jar"/>
                <include name="log.jar"/>                
                <include name="adminweb.war"/>
        </fileset>
    </copy>
  
    <!-- Jar the ear package together -->
    <jar basedir="${caear.earbuild}" jarfile="${caear}"/>    
  </target>

  <!-- =================================================================== -->
  <!-- Build CA-ear without web-RA                                         -->
  <!-- =================================================================== -->
  <target name="canora.ear" depends="apply.war, webdist.war, ca.jar, ra.jar, log.jar">
    <mkdir dir="${caearnora.build}"/>
    <copy todir="${caearnora.earbuild}">
        <fileset dir="${caear.earsrc}"> 
                <include name="**/*"/>
                <exclude name="META-INF/application.xml"/>
        </fileset>
    </copy>
    <copy todir="${caearnora.warbuild}">
        <fileset dir="${caear.warsrc}"> 
                <include name="**/*"/>
        </fileset>
    </copy>
    
    <!-- Rename application.xml without web-RA -->
    <move file="${caearnora.build}/ear/META-INF/application-nora.xml" tofile="${caearnora.build}/ear/META-INF/application.xml"/>
    
    <!-- Jar the ROOT war together -->
    <jar basedir="${caearnora.warbuild}" jarfile="${canorarootwar}"/>    

    <copy todir="${caearnora.earbuild}">
        <fileset dir="${dist}">
                <include name="webdist.war"/>
                <include name="apply.war"/>
                <include name="ca.jar"/>
                <include name="log.jar"/>                 
                <include name="ra.jar"/>
        </fileset>
    </copy>
  
    <!-- Jar the ear package together -->
    <jar basedir="${caearnora.earbuild}" jarfile="${caearnora}"/>    
  </target>
  
  <!-- =================================================================== -->
  <!-- Build Javadoc part                                                -->
  <!-- =================================================================== -->
  <target name="javadoc" depends="">
        <mkdir dir="${apidoc}"/>
        <javadoc packagenames="se.anatom.*"
                maxmemory="256m"
                sourcepath="${javasrc}"
                destdir="${apidoc}"
                extdirs="${lib}"
                author="true"
                version="true"
                use="true"
                windowtitle="EJBCA API"
                bottom="Copyright &#169; 2001 AnaTom.">
        </javadoc>
  </target>

  <!-- =================================================================== -->
  <!-- Run JUnit tests                                                     -->
  <!-- =================================================================== -->
<!--
  <target name="test" depends="build">
        <junit printsummary="yes" haltonfailure="yes">
          <formatter type="plain" />
          <batchtest fork="yes" todir=".">
            <fileset dir="${javasrc}">
              <include name="**/junit/**/Test*.java" />
              <exclude name="**/TestRunner.java" />
            </fileset>
          </batchtest>
        </junit>
  </target>
-->

</project>

