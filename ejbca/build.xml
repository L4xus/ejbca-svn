<?xml version="1.0"?>

<project name="ejbca" default="build" basedir=".">

  <!-- set global properties for this build -->
  <property name="src" value="./src"/>
  <property name="javasrc" value="${src}/java"/>
  <property name="lib" value="./lib"/>
  <property name="tmp" value="./tmp" />
  <property name="build" value="${tmp}/classes"/>
  <property name="dist"  value="./dist"/>
  <property name="apidoc" value="./doc/api"/>
  
  <property name="apply.src" value="${src}/publicweb/apply" />
  <property name="apply.build" value="${tmp}/publicweb/apply.war" />
  <property name="applyjar" value="${dist}/apply.war" />
  
  <property name="webdist.src" value="${src}/publicweb/webdist" />
  <property name="webdist.build" value="${tmp}/publicweb/webdist.war" />
  <property name="webdistjar" value="${dist}/webdist.war" />

  <property name="sampleauth.src" value="${src}/ca/sampleauth" />
  <property name="sampleauth.build" value="${tmp}/ca/sampleauth.war" />
  <property name="sampleauthjar" value="${dist}/sampleauth.war" />

  <property name="ca.src" value="${src}/ca/ca" />
  <property name="ca.build" value="${tmp}/ca/ca.jar" />
  <property name="cajar" value="${dist}/ca.jar" />

  <property name="status.src" value="${src}/publicweb/status"/>
  <property name="status.build" value="${tmp}/publicweb/status.war"/>
  <property name="statusjar" value="${dist}/status.war"/>

  <property name="log.src" value="${src}/log" />
  <property name="log.build" value="${tmp}/log.jar" />
  <property name="logjar" value="${dist}/log.jar" />  
  
  <property name="authorization.src" value="${src}/authorization" />
  <property name="authorization.build" value="${tmp}/authorization.jar" />
  <property name="authorizationjar" value="${dist}/authorization.jar" />    
  
  <property name="hardtoken.src" value="${src}/hardtoken" />
  <property name="hardtoken.build" value="${tmp}/hardtoken.jar" />
  <property name="hardtokenjar" value="${dist}/hardtoken.jar" />   
  
  <property name="keyrecovery.src" value="${src}/keyrecovery" />
  <property name="keyrecovery.build" value="${tmp}/keyrecovery.jar" />
  <property name="keyrecoveryjar" value="${dist}/keyrecovery.jar" />   
   
  <property name="ra.src" value="${src}/ra" />
  <property name="ra.build" value="${tmp}/ra.jar" />
  <property name="rajar" value="${dist}/ra.jar" />
  
  <property name="adminweb.src" value="${src}/adminweb" />
  <property name="adminweb.build" value="${tmp}/adminweb.war" />
  <property name="adminwebjar" value="${dist}/adminweb.war" />  
  
  <property name="demoweb.src" value="${src}/demoweb" />
  <property name="demoweb.build" value="${tmp}/demoweb.war" />
  <property name="demowebjar" value="${dist}/demoweb.war" />  

  <property name="caear.src" value="${src}/ca/ear" />
  <property name="caear.earsrc" value="${caear.src}/ear" />
  <property name="caear.warsrc" value="${src}/publicweb/root" />
  <property name="caear.build" value="${tmp}/ca/ear" />
  <property name="caear.warbuild" value="${tmp}/publicweb/publicwebroot.war" />
  <property name="caear.earbuild" value="${tmp}/ca/ear/ear" />
  <property name="carootwar" value="${caear.earbuild}/publicwebroot.war" />
  <property name="caear" value="${dist}/ejbca-ca.ear" />

  <property name="caearnora.build" value="${tmp}/canora/ear" />
  <property name="caearnora.warbuild" value="${tmp}/canora/ear/publicwebroot.war" />
  <property name="caearnora.earbuild" value="${tmp}/canora/ear/ear" />
  <property name="canorarootwar" value="${caearnora.earbuild}/publicwebroot.war" />
  <property name="caearnora" value="${dist}/ejbca-canora.ear" />

  <property name="createcrlservice.build" value="${tmp}/crlcreateservice.jar" />
  <property name="createcrlservicejar" value="${dist}/crlcreateservice.jar" />

  <!-- Jar with class files needed for administration, i.e. ca, ra, jobrunner -->
  <property name="adminjar.cli" value="${src}/cli" />
  <property name="adminjar.build" value="${tmp}/adminjar" />
  <property name="adminjar" value="./admin.jar" />

  <property name="jar.classpath" value="lib/bcmail-jdk14-122.jar lib/bcprov-jdk14-122.jar lib/log4j-1.2.7.jar lib/ldap.jar lib/commons-lang-2.0.jar lib/commons-collections.jar lib/commons-fileupload-1.0.jar"/>
  
  <property environment="env"/>
  
  <!-- =================================================================== -->
  <!-- Create the time stamp and build directory -->
  <!-- =================================================================== -->
  <target name="init">
    <!-- Create the time stamp -->
    <tstamp/>
    <!-- Create the build directory structure used by compile -->
    <mkdir dir="${build}"/>
    <mkdir dir="${dist}"/>
  </target>

  <!-- =================================================================== -->
  <!-- Clean ALL                                                           -->
  <!-- =================================================================== -->
  <target name="clean">
    <!-- Delete the ${build} and ${dist} directory trees -->
    <delete dir="${build}"/>
    <delete dir="${dist}"/>
    <delete dir="${tmp}"/>
    <delete dir="${apidoc}"/>
    <delete file="admin.jar"/>
    <delete>
        <fileset dir="${javasrc}" 
includes="**/*.class,**/*.log,**/.nbattrs,**/filesystem.attributes"/>
    </delete>
    
  </target>

  <!-- =================================================================== -->
  <!-- Build ALL                                                           -->
  <!-- =================================================================== -->
  <target name="build" depends="compile, apply.war, status.war, webdist.war, ca.jar, log.jar, authorization.jar,
  hardtoken.jar, keyrecovery.jar, ca.ear, canora.ear, ra.jar, adminweb.war, admin.jar, sampleauth.war">
  </target>

  <!-- =================================================================== -->
  <!-- Compile java sources                                                -->
	  <!-- =================================================================== -->
  <target name="compile" depends="init">
    <!-- Compile the java code from ${javasrc} into ${build} -->
    <javac srcdir="${javasrc}" extdirs="${lib}" destdir="${build}" debug="on" encoding="iso8859-1">
        <exclude name="**/CVS/**"/>    
        <exclude name="**/appserver/**"/> <!-- appserver specific files are built separtely-->
        <include name="**/*.java"/>
    </javac>
    <copy todir="${javasrc}">
        <fileset dir="${build}">
                <include name="**/*.class"/>
        </fileset>
    </copy> 

  </target>

  <!-- =================================================================== -->
  <!-- Build apply part                                                    -->
  <!-- =================================================================== -->
  <target name="apply.war" depends="compile">
    <mkdir    dir="${apply.build}"/>
    <copy todir="${apply.build}">
        <fileset dir="${apply.src}"> 
                <include name="**/*"/>
        </fileset>
    </copy>
    <copy todir="${apply.build}/WEB-INF/classes">
        <fileset dir="${build}">
                <include name="se/anatom/ejbca/apply/**/*.class"/>
                <include name="se/anatom/ejbca/ca/sign/**/ISign*.class"/>
                <include name="se/anatom/ejbca/util/**/Base64*.class"/>
                <include name="se/anatom/ejbca/util/**/CertTools*.class"/>
                <include name="se/anatom/ejbca/util/**/FileTools*.class"/>
                <include name="se/anatom/ejbca/protocol/*.class"/>
                <include name="se/anatom/ejbca/exception/**/*.class"/>
                <include name="se/anatom/ejbca/ca/exception/**/*.class"/>
                <include name="se/anatom/ejbca/log/Admin.class"/>                
                <exclude name="se/anatom/ejbca/**/*Test*"/>
        </fileset>
    </copy>
  
    <!-- Jar the apply.war package together -->
    <jar basedir="${apply.build}" jarfile="${applyjar}">    
        <manifest>
            <attribute name="Class-Path" value="${jar.classpath}"/>
        </manifest>
    </jar>
  </target>
  
    <!-- =================================================================== -->
    <!-- Build status part                                                                                                                             -->
    <!-- =================================================================== -->
    <target name="status.war" depends="compile">
        <mkdir dir="${status.build}"/>
        <copy todir="${status.build}">
            <fileset dir="${status.src}">
                <include name="**/*"/>
            </fileset>
        </copy>
        <copy todir="${status.build}/WEB-INF/classes">
            <fileset dir="${build}">
                <include name="se/anatom/ejbca/protocol/OCSPServlet*.class"/>
                <include name="se/anatom/ejbca/protocol/exception/MalformedRequestException*.class"/>
				<include name="se/anatom/ejbca/SecConst*.class"/>
				<include name="se/anatom/ejbca/ca/crl/RevokedCertInfo*.class"/>
                <include name="se/anatom/ejbca/ca/exception/**/*.class"/>
				<include name="se/anatom/ejbca/ca/store/ICertificateStoreSessionLocalHome*.class"/>
				<include name="se/anatom/ejbca/ca/store/ICertificateStoreSessionLocal*.class"/>
				<include name="se/anatom/ejbca/log/Admin*.class"/>
				<include name="se/anatom/ejbca/util/Hex*.class"/>
                <include name="se/anatom/ejbca/util/**/CertTools*.class"/>
                <exclude name="se/anatom/ejbca/**/*Test*"/>
            </fileset>
        </copy>
        <!-- Jar the status.war package together -->
        <jar basedir="${status.build}" jarfile="${statusjar}">
            <manifest>
                <attribute name="Class-Path" value="${jar.classpath}"/>
            </manifest>
        </jar>
    </target>
  
  <!-- =================================================================== -->
  <!-- Build sampleauth part                                               -->
  <!-- =================================================================== -->
  <target name="sampleauth.war" depends="compile">
    <mkdir    dir="${sampleauth.build}"/>
    <copy todir="${sampleauth.build}">
        <fileset dir="${sampleauth.src}"> 
                <include name="**/*"/>
        </fileset>
    </copy>
    <copy todir="${sampleauth.build}/WEB-INF/classes">
        <fileset dir="${build}">
                <include name="se/anatom/ejbca/samples/AuthResult*.class"/>
                <include name="se/anatom/ejbca/samples/RemoteVerify*.class"/>
                <include name="se/anatom/ejbca/exception/**/*.class"/>
                <include name="se/anatom/ejbca/ca/exception/**/*.class"/>
                <include name="se/anatom/ejbca/log/Admin.class"/>                 
                <exclude name="se/anatom/ejbca/**/*Test*"/>
        </fileset>
    </copy>
    <copy todir="${sampleauth.build}/WEB-INF/lib">
        <fileset dir="${lib}">
                <include name=""/>
        </fileset>
    </copy>
  
    <!-- Jar the sampleauth.war package together -->
    <jar basedir="${sampleauth.build}" jarfile="${sampleauthjar}"/>    
  </target>

  <!-- =================================================================== -->
  <!-- Build ca part                                                    -->
  <!-- =================================================================== -->
  <target name="ca.jar" depends="compile">
    <mkdir    dir="${ca.build}"/>
    <copy todir="${ca.build}">
        <fileset dir="${ca.src}"> 
                <include name="**/*"/>
                <exclude name="keyStore/**"/>
        </fileset>
        <fileset dir="${build}">
                <include name="se/anatom/ejbca/**/*.class"/>
                <exclude name="se/anatom/ejbca/**/*Test*"/>
        </fileset>
        <fileset dir="${src}">
                <include name="upgrade/**/*.sql"/>
        </fileset>

    </copy>
    
    <!-- Jar the ca.jar package together -->
    <jar basedir="${ca.build}" jarfile="${cajar}">
        <manifest>
            <attribute name="Class-Path" value="${jar.classpath}"/>
        </manifest>
    </jar>
  </target>

  <!-- =================================================================== -->
  <!-- Build log part                                                    -->
  <!-- =================================================================== -->
  <target name="log.jar" depends="compile">
    <mkdir    dir="${log.build}"/>
    <copy todir="${log.build}">
        <fileset dir="${log.src}"> 
                <include name="**/*"/>
        </fileset>
    </copy>
    <copy todir="${log.build}">
        <fileset dir="${build}">
                <include name="se/anatom/ejbca/log/*.class"/>
                <include name="se/anatom/ejbca/util/query/*.class"/>                
                <exclude name="se/anatom/ejbca/**/*Test*"/>
        </fileset>
    </copy>
    
    <!-- Jar the log.jar package together -->
    <jar basedir="${log.build}" jarfile="${logjar}">    
        <manifest>
            <attribute name="Class-Path" value="${jar.classpath}"/>
        </manifest>
    </jar>
  </target>  

  <!-- =================================================================== -->
  <!-- Build authorization part                                            -->
  <!-- =================================================================== -->
  <target name="authorization.jar" depends="compile">
    <mkdir dir="${authorization.build}"/>
    <copy todir="${authorization.build}">
      <fileset dir="${authorization.src}">
        <include name="**/*"/>
      </fileset>
    </copy>
    <copy todir="${authorization.build}">
        <fileset dir="${build}">
                <include name="se/anatom/ejbca/authorization/*.class"/>
                <include name="se/anatom/ejbca/ca/caadmin/I*.class"/>
                <include name="se/anatom/ejbca/ca/caadmin/*Info.class"/>
                <include name="se/anatom/ejbca/ra/I*.class"/>                                                              
                <include name="se/anatom/ejbca/ra/raadmin/I*.class"/>                                                              
                <include name="se/anatom/ejbca/ca/store/I*.class"/>  
                <include name="se/anatom/ejbca/log/I*.class"/>
                <include name="se/anatom/ejbca/log/Admin.class"/>  
                <include name="se/anatom/ejbca/log/LogEntry.class"/>
                <include name="se/anatom/ejbca/util/*.class"/> 
                <include name="se/anatom/ejbca/*.class"/>                                  
                <exclude name="se/anatom/ejbca/**/*Test*"/>
        </fileset>
    </copy>
    <jar basedir="${authorization.build}" jarfile="${authorizationjar}">    
        <manifest>
            <attribute name="Class-Path" value="${jar.classpath}"/>
        </manifest>
    </jar>
  </target>      
  
  <!-- =================================================================== -->
  <!-- Build hard token part                                               -->
  <!-- =================================================================== -->
  <target name="hardtoken.jar" depends="compile">
    <mkdir dir="${hardtoken.build}"/>
    <copy todir="${hardtoken.build}">
      <fileset dir="${hardtoken.src}">
        <include name="**/*"/>
      </fileset>
    </copy>
    <copy todir="${hardtoken.build}">
        <fileset dir="${build}">
                <include name="se/anatom/ejbca/hardtoken/*.class"/>
                <include name="se/anatom/ejbca/ra/I*.class"/>
                <include name="se/anatom/ejbca/ra/UserAdminData.class"/>  
                <include name="se/anatom/ejbca/ra/UserDataLocal.class"/> 
                <include name="se/anatom/ejbca/ra/UserDataLocalHome.class"/>                                                
                <include name="se/anatom/ejbca/authorization/I*.class"/>                
                <include name="se/anatom/ejbca/authorization/*Exception.class"/>
                <include name="se/anatom/ejbca/ca/store/I*.class"/>  
                <include name="se/anatom/ejbca/log/I*.class"/>
                <include name="se/anatom/ejbca/log/Admin.class"/>  
                <include name="se/anatom/ejbca/log/LogEntry.class"/>
                <include name="se/anatom/ejbca/util/CertTools.class"/> 
                <include name="se/anatom/ejbca/SecConst.class"/>                                  
                 <include name="se/anatom/ejbca/BaseProperty*.class"/>
                                  <include name="se/anatom/ejbca/PropertyEntityPK.class"/>
                <exclude name="se/anatom/ejbca/**/*Test*"/>
        </fileset>
    </copy>
    <jar basedir="${hardtoken.build}" jarfile="${hardtokenjar}">    
        <manifest>
            <attribute name="Class-Path" value="${jar.classpath}"/>
        </manifest>
    </jar>
  </target>    
  
  <!-- =================================================================== -->
  <!-- Build key recovery part                                             -->
  <!-- =================================================================== -->
  <target name="keyrecovery.jar" depends="compile">
    <mkdir    dir="${keyrecovery.build}"/>
    <copy todir="${keyrecovery.build}">
        <fileset dir="${keyrecovery.src}"> 
                <include name="**/*"/>
        </fileset>
    </copy>
    <copy todir="${keyrecovery.build}">
        <fileset dir="${build}">
                <include name="se/anatom/ejbca/keyrecovery/*.class"/>                                               
                <include name="se/anatom/ejbca/ca/sign/I*.class"/>                
                <include name="se/anatom/ejbca/ca/store/I*.class"/>  
                <include name="se/anatom/ejbca/log/I*.class"/>
                <include name="se/anatom/ejbca/log/Admin.class"/>  
                <include name="se/anatom/ejbca/log/LogEntry.class"/>
                <include name="se/anatom/ejbca/util/CertTools.class"/> 
                <include name="se/anatom/ejbca/SecConst.class"/>                                  
                <exclude name="se/anatom/ejbca/**/*Test*"/>
        </fileset>
    </copy>
    
    <jar basedir="${keyrecovery.build}" jarfile="${keyrecoveryjar}">    
        <manifest>
            <attribute name="Class-Path" value="${jar.classpath}"/>
        </manifest>
    </jar>
  </target>      


  <!-- =================================================================== -->
  <!-- Build ra part                                                       -->
  <!-- =================================================================== -->
  <target name="ra.jar" depends="compile">
    <mkdir    dir="${ra.build}"/>
    <copy todir="${ra.build}">
        <fileset dir="${ra.src}"> 
                <exclude name="**web/raadmin/**"/>
                <include name="**/*"/>
        </fileset>
    </copy>
    <copy todir="${ra.build}">
        <fileset dir="${build}">
                <include name="se/anatom/ejbca/ra/**/*.class"/>                
                <include name="se/anatom/ejbca/ca/caadmin/I*.class"/>
                <include name="se/anatom/ejbca/ca/caadmin/*Info.class"/>
                <include name="se/anatom/ejbca/authorization/I*.class"/>
                <include name="se/anatom/ejbca/authorization/*Exception.class"/>            
                <include name="se/anatom/ejbca/*.class"/>
                <include name="se/anatom/ejbca/util/**/*.class"/>
                <include name="se/anatom/ejbca/util/query/*.class"/>   
                <include name="se/anatom/ejbca/log/Admin.class"/>                              
                <exclude name="se/anatom/ejbca/**/*Test*"/>           
        </fileset>
    </copy>
    
    <!-- Jar the ra.jar package together -->
    <jar  basedir="${ra.build}" jarfile="${rajar}">
        <manifest>
            <attribute name="Class-Path" value="${jar.classpath}"/>
        </manifest>
    </jar>
  </target>

  <!-- =================================================================== -->
  <!-- Build webdist part                                                  -->
  <!-- =================================================================== -->
  <target name="webdist.war" depends="compile">
    <mkdir    dir="${webdist.build}"/>
    <copy todir="${webdist.build}">
        <fileset dir="${webdist.src}"> 
                <include name="**/**"/>
        </fileset>
    </copy>
    <copy todir="${webdist.build}/WEB-INF/classes">
        <fileset dir="${build}">
                <include name="se/anatom/ejbca/webdist/*.class"/>                
                <include name="se/anatom/ejbca/ca/caadmin/I*.class"/>
                <include name="se/anatom/ejbca/ca/caadmin/*Info.class"/>
                <include name="se/anatom/ejbca/ca/store/ICertificateStore*.class"/>
                <include name="se/anatom/ejbca/ca/store/certificatetypes/*.class"/>                
                <include name="se/anatom/ejbca/ca/publisher/IPublisher*.class"/>
                <include name="se/anatom/ejbca/ca/sign/ISign*.class"/>
                <include name="se/anatom/ejbca/ca/crl/**/RevokedCertInfo*.class"/>
                <include name="se/anatom/ejbca/util/**/Base64*.class"/>
                <include name="se/anatom/ejbca/util/**/CertTools*.class"/>
                <include name="se/anatom/ejbca/util/**/Hex*.class"/>
                <include name="se/anatom/ejbca/exception/**/*.class"/>
                <include name="se/anatom/ejbca/ca/exception/**/*.class"/>
                <include name="se/anatom/ejbca/log/Admin.class"/>                 
                <exclude name="se/anatom/ejbca/**/*Test*"/>
        </fileset>
    </copy>
  
    <!-- Jar the webdist.war package together -->
    <jar basedir="${webdist.build}" jarfile="${webdistjar}">    
        <manifest>
            <attribute name="Class-Path" value="${jar.classpath}"/>
        </manifest>
    </jar>
  </target>

  <!-- =================================================================== -->
  <!-- Build admin web part                                                -->
  <!-- =================================================================== -->
  <target name="adminweb.war" depends="compile">
    <mkdir dir="${adminweb.build}"/>
    <copy todir="${adminweb.build}">
      <fileset dir="${adminweb.src}">
        <include name="**/**"/>
        <exclude name="**/tomcat*-service.xml"/>
      </fileset>
    </copy>
    <copy todir="${adminweb.build}/WEB-INF/classes">
      <fileset dir="${build}">
        <include name="se/anatom/ejbca/util/*.class"/>
        <exclude name="se/anatom/ejbca/**/*Test*"/>
      </fileset>
    </copy>
    <!-- Jar the adminweb.war package together -->
    <jar basedir="${adminweb.build}" jarfile="${adminwebjar}">
        <manifest>
            <attribute name="Class-Path" value="${jar.classpath}"/>
        </manifest>
    </jar>
  </target>

  <!-- =================================================================== -->
  <!-- Build demo web part                                              -->
  <!-- =================================================================== -->
  <target name="demoweb.war" depends="compile">
    <mkdir    dir="${demoweb.build}"/>
    <copy todir="${demoweb.build}">
        <fileset dir="${demoweb.src}"> 
                <include name="**/**"/>
        </fileset>
    </copy>
    <copy todir="${demoweb.build}/WEB-INF/classes">
        <fileset dir="${build}">
                <include name="se/anatom/ejbca/webdist/**/*.class"/>                
                <include name="se/anatom/ejbca/ca/caadmin/I*.class"/>
                <include name="se/anatom/ejbca/ca/caadmin/*Info.class"/>
                <include name="se/anatom/ejbca/ca/store/CertificateData*.class"/>                
                <include name="se/anatom/ejbca/ca/store/ICertificateStore*.class"/>         
                <include name="se/anatom/ejbca/ca/store/certificateprofiles/*.class"/>                        
                <include name="se/anatom/ejbca/ra/*.class"/>
                <include name="se/anatom/ejbca/authorization/*.class"/>      
                <include name="se/anatom/ejbca/ra/raadmin/*.class"/>
                <include name="se/anatom/ejbca/ca/publisher/IPublisher*.class"/>
                <include name="se/anatom/ejbca/ca/sign/ISignSession*.class"/>
                <include name="se/anatom/ejbca/ca/crl/**/RevokedCertInfo*.class"/>
                <include name="se/anatom/ejbca/util/*.class"/>
                <include name="se/anatom/ejbca/util/query/*.class"/>                
                <include name="se/anatom/ejbca/exception/**/*.class"/>
                <include name="se/anatom/ejbca/ca/exception/**/*.class"/>           
                <include name="se/anatom/ejbca/log/Admin.class"/>                 
                <exclude name="se/anatom/ejbca/**/*Test*"/>
        </fileset>
    </copy>
    <!-- Jar the demoweb.war package together -->
    <jar basedir="${demoweb.build}" jarfile="${demowebjar}">    
        <manifest>
            <attribute name="Class-Path" value="${jar.classpath}"/>
        </manifest>
    </jar>
  </target>

  <!-- =================================================================== -->
  <!-- Build admin jar                                                     -->
  <!-- =================================================================== -->
  <target name="admin.jar" depends="compile">
    <mkdir dir="${adminjar.build}"/>
         <copy todir="${adminjar.build}">
        <fileset dir="${adminjar.cli}">
               <include name="*.properties"/>                                
       </fileset>
      </copy>
     <copy todir="${adminjar.build}">
        <fileset dir="${build}">
               <include name="se/anatom/ejbca/IJobRunner*.class"/>
                <include name="se/anatom/ejbca/SecConst*.class"/>
                <include name="se/anatom/ejbca/util/*.class"/> 
                <include name="se/anatom/ejbca/util/query/*.class"/>
                <include name="se/anatom/ejbca/util/passgen/*.class"/>
                <include name="se/anatom/ejbca/admin/*.class"/>
                <include name="se/anatom/ejbca/batch/*.class"/>                
                <include name="se/anatom/ejbca/ca/caadmin/I*.class"/>
                <include name="se/anatom/ejbca/ca/caadmin/*Info.class"/>
                <include name="se/anatom/ejbca/ca/store/*Info.class"/>
                <include name="se/anatom/ejbca/ca/store/ICertificateStore*.class"/>
                <include name="se/anatom/ejbca/ca/store/certificateprofiles/*.class"/>                
                <include name="se/anatom/ejbca/ca/publisher/IPublisher*.class"/>
                <include name="se/anatom/ejbca/ca/sign/ISignSession*.class"/>
                <include name="se/anatom/ejbca/ca/crl/RevokedCertInfo*.class"/>
                <include name="se/anatom/ejbca/ca/crl/ICreateCRL*.class"/>
                <include name="se/anatom/ejbca/ca/store/CertificateData*.class"/>
                <include name="se/anatom/ejbca/ca/store/ICertificateStore*.class"/> 
                <include name="se/anatom/ejbca/ra/*.class"/> 
                <include name="se/anatom/ejbca/exception/**/*.class"/>
                <include name="se/anatom/ejbca/ca/exception/**/*.class"/> 
                <include name="se/anatom/ejbca/ra/exception/**/*.class"/> 
                <include name="se/anatom/ejbca/ra/raadmin/AdminPreference.class"/>   
                <include name="se/anatom/ejbca/ra/raadmin/UserDoesntFullfillEndEntityProfile.class"/>   
                <include name="se/anatom/ejbca/ra/raadmin/IRaAdminSessionHome.class"/>   
                <include name="se/anatom/ejbca/ra/raadmin/IRaAdminSessionRemote.class"/>
                <include name="se/anatom/ejbca/ra/raadmin/EndEntityProfile.class"/> 
                <include name="se/anatom/ejbca/ra/raadmin/GlobalConfiguration.class"/>
                <include name="se/anatom/ejbca/ra/raadmin/EndEntityProfileExistsException.class"/>                   
                <include name="se/anatom/ejbca/authorization/IAuthorizationSessionHome.class"/>       
                <include name="se/anatom/ejbca/authorization/IAuthorizationSessionRemote.class"/>                              
                <include name="se/anatom/ejbca/authorization/AdminGroup.class"/>       
                <include name="se/anatom/ejbca/authorization/*Exception.class"/>
                <include name="se/anatom/ejbca/authorization/UserEntity.class"/>
                <include name="se/anatom/ejbca/authorization/AdminInformation.class"/>                 
                <include name="se/anatom/ejbca/hardtoken/AvailableHardToken.class"/>  
                <include name="se/anatom/ejbca/hardtoken/IHardTokenSessionHome.class"/> 
                <include name="se/anatom/ejbca/hardtoken/IHardTokenSessionRemote.class"/>     
                <include name="se/anatom/ejbca/hardtoken/IHardTokenBatchJobSessionHome.class"/>
                <include name="se/anatom/ejbca/hardtoken/IHardTokenBatchJobSessionRemote.class"/>
                <include name="se/anatom/ejbca/hardtoken/HardTokenIssuer.class"/>   
                <include name="se/anatom/ejbca/hardtoken/HardTokenIssuerData.class"/>   
                <include name="se/anatom/ejbca/hardtoken/*Exception.class"/>
                <include name="se/anatom/ejbca/hardtoken/hardtokentypes/*.class"/>   
                <include name="se/anatom/ejbca/hardtoken/hardtokenprofiles/*.class"/>   
                <include name="se/anatom/ejbca/hardtoken/HardTokenData.class"/>                 
                <include name="se/anatom/ejbca/hardtoken/UnavailableTokenException.class"/>
                <include name="se/anatom/ejbca/hardtoken/HardTokenExistsException.class"/> 
                <include name="se/anatom/ejbca/hardtoken/HardTokenDoesntExistsException.class"/>         
                <include name="se/anatom/ejbca/keyrecovery/IKeyRecoverySessionRemote.class"/>      
                <include name="se/anatom/ejbca/keyrecovery/IKeyRecoverySessionHome.class"/> 
                <include name="se/anatom/ejbca/keyrecovery/KeyRecoveryData.class"/>                                                                              
                <include name="se/anatom/ejbca/log/Admin.class"/>                                                                                                                                                                                                 
                <include name="se/anatom/ejbca/protocol/IResponseMessage.class"/>
                <include name="se/anatom/ejbca/protocol/IRequestMessage.class"/>                                                                                                                                                                                                 
                <include name="se/anatom/ejbca/protocol/PKCS10RequestMessage.class"/>                                                                                                                                                                                                 
                <include name="se/anatom/ejbca/protocol/IResponseMessage.class"/>                                                                                                                                                                                                 
                <include name="se/anatom/ejbca/protocol/X509ResponseMessage.class"/>                                                                                                                                                                                                 
                <include name="se/anatom/ejbca/ra/raadmin/DNFieldExtractor.class"/>                                                                                                                                                                                                 
                <include name="se/anatom/ejbca/ca/caadmin/extendedcaservices/ExtendedCAServiceRequest.class"/>                                                                                                                                                                                                 
                <include name="se/anatom/ejbca/ca/caadmin/extendedcaservices/ExtendedCAServiceResponse.class"/>                                                                                                                                                                                                 
                <include name="se/anatom/ejbca/ca/caadmin/extendedcaservices/IllegalExtendedCAServiceRequestException.class"/>                                                                                                                                                                                                 
                <include name="se/anatom/ejbca/ca/caadmin/extendedcaservices/ExtendedCAServiceRequestException.class"/>
                <include name="se/anatom/ejbca/ca/caadmin/extendedcaservices/ExtendedCAServiceNotActiveException.class"/>
                <include name="se/anatom/ejbca/ca/caadmin/extendedcaservices/OCSPCAServiceInfo.class"/>
                <include name="se/anatom/ejbca/ca/caadmin/extendedcaservices/ExtendedCAServiceInfo.class"/>
                <include name="se/anatom/ejbca/upgrade/*.class"/>
                <exclude name="se/anatom/ejbca/**/*Test*"/> 
       </fileset>
      </copy>
    <!-- Jar the admin.jar package together -->
    <jar basedir="${adminjar.build}" jarfile="${adminjar}"/>    
  </target>

  <!-- =================================================================== -->
  <!-- Build CA-ear                                                        -->
  <!-- =================================================================== -->
  <target name="ca.ear" depends="apply.war, status.war, webdist.war, ca.jar, ra.jar, adminweb.war, log.jar, hardtoken.jar, keyrecovery.jar, authorization.jar">
    <mkdir dir="${caear.build}"/>
    <copy todir="${caear.earbuild}">
        <fileset dir="${caear.earsrc}"> 
                <include name="**/*"/>
                <exclude name="META-INF/application-nora.xml"/>
        </fileset>
    </copy>
    <copy todir="${caear.warbuild}">
        <fileset dir="${caear.warsrc}"> 
                <include name="**/*"/>
        </fileset>
    </copy>
    
    <!-- Jar the ROOT war together -->
    <jar basedir="${caear.warbuild}" jarfile="${carootwar}"/>    

    <copy todir="${caear.earbuild}">
        <fileset dir="${dist}">
                <include name="webdist.war"/>
                <include name="apply.war"/>
                <include name="status.war"/>
                <include name="ca.jar"/>
                <include name="ra.jar"/>
                <include name="log.jar"/>         
                <include name="authorization.jar"/>
                <include name="hardtoken.jar"/>   
                <include name="keyrecovery.jar"/>                                        
                <include name="adminweb.war"/>
        </fileset>
    </copy>
    <copy todir="${caear.earbuild}/lib">
        <fileset dir="${lib}">
            <include name="bcmail-jdk14-122.jar"/>
            <include name="bcprov-jdk14-122.jar"/>
            <include name="log4j-1.2.7.jar"/>
            <include name="ldap.jar"/>
            <include name="commons-lang-2.0.jar"/>
            <include name="commons-collections.jar"/>
            <include name="commons-fileupload-1.0.jar"/>
        </fileset>
    </copy>
  
    <!-- Jar the ear package together -->
    <jar basedir="${caear.earbuild}" jarfile="${caear}"/>
  </target>

  <!-- =================================================================== -->
  <!-- Build CA-ear without web-RA                                         -->
  <!-- =================================================================== -->
  <target name="canora.ear" depends="apply.war, status.war, webdist.war, ca.jar, ra.jar, log.jar">
    <mkdir dir="${caearnora.build}"/>
    <copy todir="${caearnora.earbuild}">
        <fileset dir="${caear.earsrc}"> 
                <include name="**/*"/>
                <exclude name="META-INF/application.xml"/>
        </fileset>
    </copy>
    <copy todir="${caearnora.warbuild}">
        <fileset dir="${caear.warsrc}"> 
                <include name="**/*"/>
        </fileset>
    </copy>
    
    <!-- Rename application.xml without web-RA -->
    <move file="${caearnora.build}/ear/META-INF/application-nora.xml" tofile="${caearnora.build}/ear/META-INF/application.xml"/>
    
    <!-- Jar the ROOT war together -->
    <jar basedir="${caearnora.warbuild}" jarfile="${canorarootwar}"/>    

    <copy todir="${caearnora.earbuild}">
        <fileset dir="${dist}">
                <include name="webdist.war"/>
                <include name="apply.war"/>
                <include name="status.war"/>
                <include name="ca.jar"/>
                <include name="log.jar"/>   
                <include name="authorization.jar"/>              
                <include name="ra.jar"/>
        </fileset>
    </copy>
    <copy todir="${caearnora.earbuild}/lib">
        <fileset dir="${lib}">
            <include name="bcmail-jdk14-122.jar"/>
            <include name="bcprov-jdk14-122.jar"/>
            <include name="log4j-1.2.7.jar"/>
            <include name="ldap.jar"/>
            <include name="commons-lang-2.0.jar"/>
            <include name="commons-collections.jar"/>
        </fileset>
    </copy>
  
    <!-- Jar the ear package together -->
    <jar basedir="${caearnora.earbuild}" jarfile="${caearnora}"/>    
  </target>
  
  <!-- =================================================================== -->
  <!-- Build Javadoc part                                                  -->
  <!-- =================================================================== -->
  <target name="javadoc" depends="">
        <mkdir dir="${apidoc}"/>
        <javadoc packagenames="se.anatom.*"
                maxmemory="256m"
                sourcepath="${javasrc}"
                destdir="${apidoc}"
                extdirs="${lib}"
                author="true"
                version="true"
                use="true"
                windowtitle="EJBCA API"
                bottom="Copyright &#169; 2003 PrimeKey Solutions AB.">
        </javadoc>
  </target>

  <!-- ========================================================================== -->
  <!-- Replace every occurrence of the DefaultDS to something else (here ejbcaDS) -->
  <!-- ========================================================================== -->
  <target name="checkForDS" unless="ejbca.DS">
	<fail message="Please run ant with -Dejbca.DS=&lt;your-datasource&gt; ( eg.java:/DefaultDS )"/> 
  </target>

  <target name="replaceDS" if="ejbca.DS" depends="checkForDS">

		<!-- Replace every occurence in the files of the Datasource -->
  		<input
		    message="Type of database :"
		    validargs="oracle,mssql,mysql,postgres,sapdb,hsqldb,sybase"
		    addproperty="ejbca.DB"
		  />
		<!-- Replace the jbosscmp xml description files by the correct ones -->
		<copy overwrite="true" file="src/ca/ca/META-INF/jbosscmp-jdbc-${ejbca.DB}.xml" tofile="src/ca/ca/META-INF/jbosscmp-jdbc.xml"/>
		<copy overwrite="true" file="src/ra/META-INF/jbosscmp-jdbc-${ejbca.DB}.xml" tofile="src/ra/META-INF/jbosscmp-jdbc.xml"/>
		<copy overwrite="true" file="src/log/META-INF/jbosscmp-jdbc-${ejbca.DB}.xml" tofile="src/log/META-INF/jbosscmp-jdbc.xml"/>
		<copy overwrite="true" file="src/authorization/META-INF/jbosscmp-jdbc-${ejbca.DB}.xml" tofile="src/authorization/META-INF/jbosscmp-jdbc.xml"/>                
		<copy overwrite="true" file="src/hardtoken/META-INF/jbosscmp-jdbc-${ejbca.DB}.xml" tofile="src/hardtoken/META-INF/jbosscmp-jdbc.xml"/>
		<copy overwrite="true" file="src/keyrecovery/META-INF/jbosscmp-jdbc-${ejbca.DB}.xml" tofile="src/keyrecovery/META-INF/jbosscmp-jdbc.xml"/>

        <replace dir="${src}" value="${ejbca.DS}">
	        <include name="**/jbosscmp-jdbc.xml"/>
	        <include name="**/ejb-jar.xml"/>
	        <replacetoken>java:/DefaultDS</replacetoken>
        </replace>
  </target>

  <!-- ========================================================================== -->
  <!-- Upgrades the database for a new version of ejbca                           -->
  <!-- ========================================================================== -->
  <target name="upgrade" depends="admin.jar">
		<!-- Get input -->
  		<input
		    message="Type of database:"
            validargs="mysql"
		    addproperty="ejbca.DB"
		  />
        <!-- validargs="hsql,oracle,mssql,mysql,postgres,sapdb,hsqldb,sybase" -->
  		<input
		    message="Data source (default java:/DefaultDS):"
		    addproperty="ejbca.DS"
		    defaultvalue="java:/DefaultDS"
		  />
	  	<java classname="se.anatom.ejbca.admin.Upgrade" fork="true">
             <sysproperty key="ejbcaDB" value="${ejbca.DB}"/>
             <sysproperty key="ejbcaDS" value="${ejbca.DS}"/>
	  		 <classpath>
                <pathelement location="."/>
	  		 	<pathelement location="${adminjar}"/>
	  		 	<fileset dir="${env.JBOSS_HOME}/client" includes="**/*.jar"/>
	  		 	<fileset dir="${lib}" includes="**/*.jar"/>
	  		 </classpath>
	  	</java>
  </target>

  <!-- ============================================================================= -->
  <!-- Batch generate certificates for users with clear text password and right type -->
  <!-- ============================================================================= -->
  <target name="batch" depends="admin.jar">
	  	<java classname="se.anatom.ejbca.batch.BatchMakeP12" fork="true">
	  		 <classpath>
	  		 	<pathelement location="${adminjar}"/>
	  		 	<fileset dir="${env.JBOSS_HOME}/client" includes="**/*.jar"/>
	  		 	<fileset dir="${lib}" includes="**/*.jar"/>
	  		 </classpath>
	  	</java>
  </target>

  <!-- =================================================================== -->
  <!-- Build Jboss Specific Services                       -->
  <!-- =================================================================== -->
  <target name="jbossservices" depends="compile">
    <path id="jbossservices.classpath">
      <pathelement location="${env.JBOSS_HOME}/lib/jboss-system.jar"/>
      <pathelement location="${env.JBOSS_HOME}/lib/jboss-common.jar"/>
      <pathelement location="${env.JBOSS_HOME}/lib/jboss-jmx.jar"/>
    </path>
      <javac srcdir="${javasrc}" extdirs="${lib}" destdir="${build}" debug="on" encoding="iso8859-1">  
        <exclude name="**/CVS/**"/>   
        <include name="**/appserver/**"/> <!-- appserver specific files are built separtely-->
        <classpath refid="jbossservices.classpath"/>
      </javac>
    <copy todir="${javasrc}">
        <fileset dir="${build}">
                <include name="**/appserver/*.class"/>
                <include name="**/appserver/**/*.class"/>
        </fileset>
    </copy> 
  

    <mkdir dir="${createcrlservice.build}"/>
    <copy todir="${createcrlservice.build}">
      <fileset dir="${src}/appserver/jboss">
        <include name="crlcreate-service.xml"/>
      </fileset>
    </copy>
    <copy todir="${createcrlservice.build}">
        <fileset dir="${build}">
                <include name="se/anatom/ejbca/appserver/jboss/CRLCreate*.class"/>
                <include name="se/anatom/ejbca/ca/crl/ICreateCRL*.class"/>
                <include name="se/anatom/ejbca/log/Admin.class"/>
                <exclude name="se/anatom/ejbca/**/*Test*"/>
        </fileset>
    </copy>
    <jar basedir="${createcrlservice.build}" jarfile="${createcrlservicejar}">    
        <manifest>
            <attribute name="Class-Path" value="${jar.classpath}"/>
        </manifest>
    </jar>
  </target>
  
  <!-- =================================================================== -->
  <!--Deploy Jboss Specific Services                       -->
  <!-- =================================================================== -->
  <target name="deployjbossservices" depends="jbossservices, deploy">
	<copy file="${createcrlservicejar}" tofile="${env.JBOSS_HOME}/server/default/deploy/createcrlservice.jar" verbose="true"/>
  </target>
  
    
  <!-- ======================================================================= -->
  <!-- Deploy EJBCA ear to JBoss                                               -->
  <!-- ======================================================================= -->
  <target name="deploy" depends="ca.ear, admin.jar">
	<copy file="${caear}" tofile="${env.JBOSS_HOME}/server/default/deploy/ejbca-ca.ear" verbose="true"/>
  </target>

  <!-- ======================================================================= -->
  <!-- Deploy ear without Admin Web-GUI to JBoss                               -->
  <!-- ======================================================================= -->
  <target name="deploy_nora" depends="canora.ear">
	<copy file="${caearnora}" tofile="${env.JBOSS_HOME}/server/default/deploy/ejbca-canora.ear" verbose="true"/>
  </target>
  
  <!-- ==================================================================== -->
  <!-- Defines the project classpath                                        -->
  <!-- ==================================================================== -->
  <path id="project.classpath" >
    <!-- our compilation directory -->
    <pathelement location="${javasrc}" />
    <!-- needed 3rd party libraries -->
    <fileset dir="${lib}" >
      <include name="**/*.jar" />
    </fileset>
  </path>

  <!-- ==================================================================== -->
  <!-- Formats all source files                                             -->
  <!-- ==================================================================== -->
  <target name="format" depends="compile">

    <!--  
      Defines the Jalopy task
    -->
    <taskdef name="jalopy" classname="de.hunsicker.jalopy.plugin.ant.AntPlugin">
      <classpath>
        <fileset dir="/java/jalopy/lib">
          <include name="*.jar" />
        </fileset>
      </classpath>
    </taskdef>
    <!--
      Invokes Jalopy as follows:
      - All formatted files will have unix fileformat (\n)
      - Load your code convention from the given url
      - Override the convention to use the file history feature
      - Override the convention to use alder32 checksums of files for history testing
      - Override the convention to use loglevel "info"
      - Override the convention to use 2 threads
      - The import optimization feature will work (if enabled in the active
        convention), because a classpath reference is specified

        Don't forget to setup an include pattern as Jalopy truly expects
        valid Java source files as input!
      -->
    <jalopy fileformat="unix"
            convention="ejbcaConventions.xml"
            history="file"
            historymethod="adler32"
            loglevel="warn"
            threads="2"
            classpathref="project.classpath">
      <fileset dir="${javasrc}">
        <include name="**/*.java" />
      </fileset>
    </jalopy>
  </target>
  
  <!-- =================================================================== -->
  <!-- Run JUnit tests                                                     -->
  <!-- =================================================================== -->
<!--
  <target name="test" depends="build">
        <junit printsummary="yes" haltonfailure="yes">
          <formatter type="plain" />
          <batchtest fork="yes" todir=".">
            <fileset dir="${javasrc}">
              <include name="**/junit/**/Test*.java" />
              <exclude name="**/TestRunner.java" />
            </fileset>
          </batchtest>
        </junit>
  </target>
-->

</project>

