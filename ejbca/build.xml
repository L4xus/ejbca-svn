<?xml version="1.0"?>
<project name="ejbca" default="build" basedir=".">

    <property name="ejbca.home" location="." />
    <property environment="env" />

    <!-- Give user a chance to override without editing this file
       (and without typing -D each time it compiles it).
       First it checks your home directory for ejbca.properties
       net it checks the properties file here. -->
    <property file="${user.home}/ejbca.properties" />
    <property file="ejbca.properties" />

    <!-- Taken from the ejbca.properties 
  <property name="jboss.home" value="${env.JBOSS_HOME}"/>
  -->
    <import file="bin/jboss.xml" />

    <!-- set global properties for this build -->
	<property name="tmp" value="./tmp" />
    <property name="bin" value="./${tmp}/bin" />
    <property name="build" value="${bin}/classes" />
    <property name="lib" value="lib" />

    <property name="src" value="src" />
    <property name="src.java" value="${src}/java" />
    <property name="src.gen" value="${bin}/gensrc" />
    <property name="src.dd" value="${bin}/dd" />
    
    <property name="test.dir" value="${bin}/junit" />
    <property name="test.src.dir" location="${src}/test" />
    <property name="dist.dir" location="dist" />
    <property name="apidoc" value="./doc/api" />

    <property name="apply.src" value="${src}/publicweb/apply" />
    <property name="applywar" value="${dist.dir}/apply.war" />

    <property name="webdist.src" value="${src}/publicweb/webdist" />
    <property name="webdistwar" value="${dist.dir}/webdist.war" />

    <property name="sampleauth.src" value="${src}/ca/sampleauth" />
    <property name="sampleauthwar" value="${dist.dir}/sampleauth.war" />

    <property name="status.src" value="${src}/publicweb/status" />
    <property name="statuswar" value="${dist.dir}/status.war" />

    <property name="adminweb.src" value="${src}/adminweb" />
    <property name="adminweb.build" value="${tmp}/adminweb.war" />    
    <property name="adminwebwar" value="${dist.dir}/adminweb.war" />

    <property name="root.warsrc" value="${src}/publicweb/root" />
    <property name="rootwar" value="${dist.dir}/publicwebroot.war" />

    <property name="caear.src" value="${src}/ca/ear" />
    <property name="caear" value="${dist.dir}/ejbca.ear" />

    <property name="createcrlservice.build" value="${tmp}/crlcreateservice.jar" />
    <property name="createcrlservicejar" value="${dist.dir}/crlcreateservice.jar" />

    <property name="jar.extclasspath" value="lib/bcmail-jdk14-124.jar lib/bcprov-jdk14-124.jar lib/log4j-1.2.7.jar lib/ldap.jar lib/commons-lang-2.0.jar lib/commons-collections.jar lib/commons-fileupload-1.0.jar"/>

    <path id="ext.classpath">
        <fileset dir="lib/ext" includes="*.jar" />
    </path>

    <path id="compile.classpath">
        <path refid="ext.classpath" />
        <fileset dir="lib" includes="*.jar" />
    </path>

    <path id="j2ee.classpath">
        <fileset dir="${jboss.home}/client">
            <include name="jbossall-client.jar" />
        </fileset>
    </path>

    <path id="xdoclet.classpath">
        <fileset dir="lib" includes="*.jar" />
        <fileset dir="lib/ext" includes="*.jar" />
        <fileset dir="lib/xdoclet-1.2.1/lib" includes="*.jar" />
    </path>

    <path id="test.compile.classpath">
        <path refid="compile.classpath" />
        <path location="${build}" />
        <path refid="j2ee.classpath" />
    </path>

    <!-- those are the default values used within JBoss for easy startup -->
    <property name="datasource.jndi-name" value="ejbcaDS" />
    <property name="database.name" value="hsqldb" />
    <property name="database.url" value="jdbc:hsqldb:$${jboss.server.data.dir}$${/}hypersonic$${/}ejbcaDB" />
    <property name="database.driver" value="org.hsqldb.jdbcDriver" />
    <property name="database.username" value="sa" />
    <property name="database.password" value="" />

    <!-- 
        ex: /my/path/myfile-postgres.xml -> /my/path/myfile.xml
    -->
    <mapper id="database.mapper" type="regexp" from="^(.*)-${database.name}\.(.*)$$" to="\1.\2" />
    <!-- does some replace magic to change the datasource jndi name -->
    <filterchain id="datasource.filters">
        <tokenfilter>
            <replacestring from="@datasource.jndi-name@" to="${datasource.jndi-name}" />
            <!-- this is just for temporary compatibility -->
            <replacestring from="DefaultDS" to="${datasource.jndi-name}" />
        </tokenfilter>
    </filterchain>

    <!-- =================================================================== -->
    <!-- Build ALL                                                           -->
    <!-- =================================================================== -->
    <target name="build" depends="ca.ear"/>

    <!-- =================================================================== -->
    <!-- Create the time stamp and build directory -->
    <!-- =================================================================== -->
    <target name="init" depends="j2ee:check">
        <echo>
---------- CONFIGURATION PROPERTIES ----------
jboss.home           = ${jboss.home}
datasource.jndi-name = ${datasource.jndi-name}
database.name        = ${database.name}
database.url         = ${database.url}
database.driver      = ${database.driver}
database.username    = ${database.username}
database.password    = ${database.password}
      </echo>
        <!-- Create the time stamp -->
        <tstamp/>
        <!-- Create the build directory structure used by compile -->
        <mkdir dir="${build}"/>
        <mkdir dir="${dist.dir}/${lib}"/>
    </target>

    <!-- =================================================================== -->
    <!-- Clean ALL                                                           -->
    <!-- =================================================================== -->
    <target name="clean">
        <!-- Delete the ${build} and ${dist.dir} directory trees -->
        <delete dir="${build}" />
        <delete dir="${dist.dir}" />
        <delete dir="${src.gen}" />
        <delete dir="${src.dd}" />
        <delete dir="${apidoc}" />
        <delete>
            <fileset dir="${src.java}" includes="**/*.class,**/*.log,**/.nbattrs,**/filesystem.attributes" />
        </delete>
        <delete dir="${tmp}"/>
    </target>

    <!-- =================================================================== -->
    <!-- Autogenerate all ejb interfaces and deployment descriptors          -->
    <!-- =================================================================== -->
    <target name="run-xdoc" depends="init">
        <taskdef name="ejbdoclet" classname="xdoclet.modules.ejb.EjbDocletTask">
            <classpath refid="xdoclet.classpath" />
        </taskdef>
        <ejbdoclet destdir="${src.gen}" ejbspec="2.0" excludedtags="@version,@author">
            <fileset dir="${src.java}">
                <include name="**/*Bean.java" />
                <exclude name="**/BaseEntityBean.java" />
                <exclude name="**/BaseSessionBean.java" />
            </fileset>
            <!--dataobject/-->
            <remoteinterface />
            <homeinterface />
            <localinterface />
            <localhomeinterface />
            <entitypk />
            <session />
            <deploymentdescriptor destdir="${src.dd}/META-INF" validatexml="false" />
            <jboss version="3.2" 
                unauthenticatedPrincipal="nobody" 
                xmlencoding="UTF-8" 
                validatexml="false" 
                destdir="${src.dd}/META-INF" 
                datasource="java:/${datasource.jndi-name}" 
                datasourcemapping="Hypersonic SQL" />
            <jonas version="4.0" 
                xmlencoding="UTF-8" 
                destdir="${src.dd}/META-INF" 
                validatexml="false" 
                defaultentityjndiname="${datasource.jndi-name}" />
            <weblogic version="7.0" 
                xmlencoding="UTF-8" 
                destdir="${src.dd}/META-INF" 
                validatexml="false" 
                datasource="${datasource.jndi-name}" 
                persistence="weblogic" />
        </ejbdoclet>
    </target>

    <!-- =================================================================== -->
    <!-- Compile java sources                                                -->
    <!-- =================================================================== -->
    <target name="compile" depends="run-xdoc">
        <javac destdir="${build}" debug="on" includeantruntime="no">
            <classpath refid="compile.classpath" />
            <exclude name="**/appserver/**" />
            <src path="${src.java}" />
            <src path="${src.gen}" />
        </javac>
    </target>

    <!-- =================================================================== -->
    <!-- Build apply part                                                    -->
    <!-- =================================================================== -->
    <target name="apply.war" depends="compile" description="build the jar file">
        <war destfile="${applywar}" webxml="${apply.src}/WEB-INF/web.xml">
            <fileset dir="${apply.src}" excludes="WEB-INF/web.xml" />
            <classes dir="${build}">
                <include name="se/anatom/ejbca/protocol/ScepServlet*" />
                <include name="se/anatom/ejbca/apply/**" />
         	</classes>
        </war>
    </target>

    <!-- =================================================================== -->
    <!-- Build status part                                                                                                                             -->
    <!-- =================================================================== -->
    <target name="status.war" depends="compile">
        <war destfile="${statuswar}" webxml="${status.src}/WEB-INF/web.xml">
            <fileset dir="${status.src}" excludes="WEB-INF/web.xml" />
            <classes dir="${build}">
                <include name="se/anatom/ejbca/protocol/OCSPServlet*.class" />
         	</classes>
        </war>
    </target>

    <!-- =================================================================== -->
    <!-- Build sampleauth part                                               -->
    <!-- =================================================================== -->
    <target name="sampleauth.war" depends="compile">
        <war destfile="${sampleauthwar}" webxml="${sampleauth.src}/WEB-INF/web.xml">
            <fileset dir="${sampleauth.src}" excludes="WEB-INF/web.xml" />
            <classes dir="${build}">
                <include name="se/anatom/ejbca/samples/AuthResult*.class" />
                <include name="se/anatom/ejbca/samples/RemoteVerify*.class" />
         	</classes>
        </war>
    </target>

    <!-- =================================================================== -->
    <!-- Build webdist part                                                  -->
    <!-- =================================================================== -->
    <target name="webdist.war" depends="compile">
        <war destfile="${webdistwar}" webxml="${webdist.src}/WEB-INF/web.xml">
            <fileset dir="${webdist.src}" excludes="WEB-INF/web.xml" />
            <classes dir="${build}">
                <include name="se/anatom/ejbca/webdist/**" />
         	</classes>
        </war>
    </target>

    <!-- =================================================================== -->
    <!-- Build admin web part                                                -->
    <!-- =================================================================== -->
    <target name="adminweb.war" depends="compile">
        <mkdir dir="${adminweb.build}/WEB-INF/lib"/>
        <copy todir="${adminweb.build}">
            <fileset dir="${adminweb.src}">
                <exclude name="**/tomcat*-service.xml"/>
            </fileset>
        </copy>
        
    	<jsp-compile uriroot="${adminweb.build}" classpathref="compile.classpath"/>
        <war destfile="${adminwebwar}" webxml="${adminweb.build}/WEB-INF/web.xml">
            <manifest>
                <attribute name="Class-Path" value="${jar.extclasspath}" />
            </manifest>
            <fileset dir="${adminweb.build}">
                <exclude name="WEB-INF/*-service.xml" />
                <exclude name="WEB-INF/web.xml"/>
            </fileset>
            <classes dir="${build}">
                <include name="se/anatom/ejbca/webdist/**" />
                <include name="se/anatom/ejbca/apply/**" />
         	</classes>
        </war>
    </target>

    <!-- =================================================================== -->
    <!-- Build public root web part                                              -->
    <!-- =================================================================== -->
    <target name="publicwebroot.war" depends="compile">
        <war destfile="${rootwar}" webxml="${root.warsrc}/WEB-INF/web.xml">
            <fileset dir="${root.warsrc}" excludes="WEB-INF/**" />
        </war>
    </target>   

    <!-- =================================================================== -->
    <!-- Build ca ejb part                                                    -->
    <!-- =================================================================== -->
    <target name="ejbca-ejb.jar" depends="compile" description="Creates master ejb.jar">
        <jar jarfile="${dist.dir}/ejbca-ejb.jar">
            <manifest>
                <!-- todo: autogenerate this from a fileset -->
                <attribute name="Class-Path" value="${jar.extclasspath}" />
            </manifest>
            <fileset dir="${src.dd}"/>
            <fileset dir="${build}"/>
            <fileset dir="${src}/log"/>
            <fileset dir="${src}/upgrade"/>
        </jar>
    </target>
    
    <!-- =================================================================== -->
    <!-- Build CA-ear                                                        -->
    <!-- =================================================================== -->
    <target name="ca.ear" depends="apply.war, status.war, webdist.war, adminweb.war, publicwebroot.war, ejbca-ejb.jar">
        <ear destfile="${caear}" appxml="${caear.src}/META-INF/application.xml"> 
            <fileset dir="${caear.src}">
                <exclude name="META-INF/application.xml" />
            </fileset>
            <fileset dir=".">
                <include name="${lib}/bcmail-jdk14-124.jar" />
                <include name="${lib}/bcprov-jdk14-124.jar" />
                <include name="${lib}/log4j-1.2.7.jar" />
                <include name="${lib}/ldap.jar" />
                <include name="${lib}/commons-lang-2.0.jar" />
                <include name="${lib}/commons-collections.jar" />
                <include name="${lib}/commons-fileupload-1.0.jar" />
            </fileset>
            <fileset dir="${dist.dir}">
                <include name="*-ejb.jar" />
                <include name="*.war" />
            </fileset>
		</ear>
    </target>

    <!-- =================================================================== -->
    <!-- Build Javadoc part                                                  -->
    <!-- =================================================================== -->
    <target name="javadoc" depends="">
        <mkdir dir="${apidoc}" />
        <javadoc packagenames="se.anatom.*" maxmemory="256m" sourcepath="${src.java}" destdir="${apidoc}" extdirs="${lib}" author="true" version="true" use="true" windowtitle="EJBCA API" bottom="Copyright &#169; 2004 PrimeKey Solutions AB.">
        </javadoc>
    </target>

    <!-- ========================================================================== -->
    <!-- Upgrades the database for a new version of ejbca                           -->
    <!-- ========================================================================== -->
    <target name="upgrade" depends="build">
        <!-- Get input -->
        <input message="Type of system:" validargs="unix,windows" addproperty="ejbca.OS" />
        <input message="Hostname for adminweb (default 127.0.0.1):" addproperty="ejbca.URL" defaultvalue="127.0.0.1" />
        <input message="Type of database:" validargs="mysql" addproperty="ejbca.DB" />
        <!-- validargs="hsql,oracle,mssql,mysql,postgres,postgres8,sapdb,hsqldb,sybase" -->
        <input message="Data source (default java:/DefaultDS):" addproperty="ejbca.DS" defaultvalue="java:/DefaultDS" />
        <input message="CA name(default MyCA):" addproperty="ejbca.CA" defaultvalue="MyCA" />
        <input message="CA keystore filename (default $JBOSS_HOME/server/default/conf/server.p12):" addproperty="ejbca.KS" defaultvalue="${jboss.home}/server/default/conf/server.p12" />
        <input message="CA keystore password:" addproperty="ejbca.KSPWD" />
        <java classname="se.anatom.ejbca.admin.Upgrade" fork="true">
            <sysproperty key="ejbcaOS" value="${ejbca.OS}" />
            <sysproperty key="ejbcaURL" value="${ejbca.URL}" />
            <sysproperty key="ejbcaDB" value="${ejbca.DB}" />
            <sysproperty key="ejbcaDS" value="${ejbca.DS}" />
            <sysproperty key="ejbcaCA" value="${ejbca.CA}" />
            <sysproperty key="ejbcaKS" value="${ejbca.KS}" />
            <sysproperty key="ejbcaKSPWD" value="${ejbca.KSPWD}" />
            <classpath>
                <pathelement location="." />
                <pathelement location="${adminjar}" />
                <fileset dir="${jboss.home}/client" includes="**/*.jar" />
                <fileset dir="${lib}" includes="**/*.jar" />
            </classpath>
        </java>
    </target>

    <!-- ============================================================================= -->
    <!-- Batch generate certificates for users with clear text password and right type -->
    <!-- ============================================================================= -->
    <target name="batch" depends="build">
        <java classname="se.anatom.ejbca.batch.BatchMakeP12" fork="true">
            <classpath>
                <fileset dir="${dist.dir}" includes="*.jar" />
                <fileset dir="${jboss.home}/client" includes="**/*.jar" />
                <fileset dir="${lib}" includes="**/*.jar" />
            </classpath>
        </java>
    </target>

    <!-- =================================================================== -->
    <!-- Build Jboss Specific Services                       -->
    <!-- =================================================================== -->
    <target name="jbossservices" depends="compile">
        <path id="jbossservices.classpath">
            <pathelement location="${jboss.home}/lib/jboss-system.jar" />
            <pathelement location="${jboss.home}/lib/jboss-common.jar" />
            <pathelement location="${jboss.home}/lib/jboss-jmx.jar" />
        </path>
        <javac srcdir="${src.java}" extdirs="${lib}" destdir="${build}" debug="on">
            <exclude name="**/CVS/**" />
            <include name="**/appserver/**" />
            <!-- appserver specific files are built separtely-->
            <classpath refid="jbossservices.classpath" />
        </javac>
        <copy todir="${src.java}">
            <fileset dir="${build}">
                <include name="**/appserver/*.class" />
                <include name="**/appserver/**/*.class" />
            </fileset>
        </copy>


        <mkdir dir="${createcrlservice.build}" />
        <copy todir="${createcrlservice.build}">
            <fileset dir="${src}/appserver/jboss">
                <include name="crlcreate-service.xml" />
            </fileset>
        </copy>
        <copy todir="${createcrlservice.build}">
            <fileset dir="${build}">
                <include name="se/anatom/ejbca/appserver/jboss/CRLCreate*.class" />
                <include name="se/anatom/ejbca/ca/crl/ICreateCRL*.class" />
                <include name="se/anatom/ejbca/log/Admin.class" />
                <exclude name="se/anatom/ejbca/**/*Test*" />
            </fileset>
        </copy>
        <jar basedir="${createcrlservice.build}" jarfile="${createcrlservicejar}">
            <manifest>
                <attribute name="Class-Path" value="${jar.classpath}" />
            </manifest>
        </jar>
    </target>

    <!-- =================================================================== -->
    <!--Deploy Jboss Specific Services                       -->
    <!-- =================================================================== -->
    <target name="deployjbossservices" depends="j2ee:assert-run,jbossservices, deploy">
        <copy file="${createcrlservicejar}" tofile="${jboss.home}/server/default/deploy/createcrlservice.jar" verbose="true" />
    </target>

    <!-- ======================================================================= -->
    <!-- Deploy EJBCA ear to JBoss                                               -->
    <!-- ======================================================================= -->
    <target name="deploy" depends="build">
        <antcall target="j2ee:deploy" />
    </target>

    <!--
        this macro is a specialized copy for deployment descriptors (dd).
        In the wonderful world of J2EE nothing it is always painful
        Basically it is copying the appropriate DD for each J2EE server
        and does some magic replace for datasource jndi name:
        @datasource.jndi-name@
    -->
    <macrodef name="ejb-dd-copy">
        <attribute name="todir" />
        <attribute name="dir" />
        <attribute name="overwrite" default="false" />
        <sequential>

            <!-- standard configuration.. should be modified with xdoclet -->
            <copy todir="@{todir}" overwrite="@{overwrite}">
                <fileset dir="@{dir}" includes="META-INF/ejb-jar.xml" />
                <filterchain refid="datasource.filters" />
            </copy>

            <!-- jboss configuration -->
            <copy todir="@{todir}" overwrite="@{overwrite}">
                <fileset dir="@{dir}" includes="META-INF/jbosscmp-jdbc*.xml" />
                <filterchain refid="datasource.filters" />
                <mapper refid="database.mapper" />
            </copy>
            <copy todir="@{todir}" overwrite="@{overwrite}">
                <fileset dir="@{dir}" includes="META-INF/jboss.xml" />
            </copy>

            <!-- weblogic configuration -->
            <copy todir="@{todir}" overwrite="@{overwrite}">
                <fileset dir="@{dir}" includes="META-INF/weblogic*.xml" />
                <filterchain refid="datasource.filters" />
            </copy>
        </sequential>
    </macrodef>

    <!--
    Macro that creates an exploded war based on the structure in use for this
    project. The 'name' attributes should match the se.anatom.ejbca.name package
    and it expects to find a directory 'name' in src with the META-INF as the
    subdirectory.
    -->
    <macrodef name="ejb-jar">
        <attribute name="name" />
        <element name="filesets" optional="yes" />
        <sequential>
            <property name="@{name}.id" value="@{name}-ejb.jar" />
            <property name="@{name}.build.dir" value="${tmp}/${@{name}.id}" />
            <mkdir dir="${@{name}.build.dir}" />

            <!-- generate xdoclet sources and dd -->
            <!-- FIXME: Comment this to use XDoclet generated DDs -->
            <property name="@{name}.tmp.dir" location="${tmp}/xdoclet/${@{name}.id}/META-INF" />
            <ejb-doclet dir="${src.java}" todir="${src.java}" module="@{name}" />

            <!-- copy/configure the dds -->
            <ejb-dd-copy todir="${@{name}.build.dir}" dir="${src}/@{name}" overwrite="true" />

            <!-- compile the module -->
            <javac srcdir="${src.java}" classpathref="compile.classpath" destdir="${build}" debug="on" includeantruntime="no">
                <include name="se/anatom/ejbca/@{name}/**" />
                <classpath path="${build}" />
            </javac>

            <!-- copy the appropriate classes -->
            <copy todir="${@{name}.build.dir}">
                <fileset dir="${build}">
                    <include name="se/anatom/ejbca/@{name}/**" />
                </fileset>
                <!-- add extra classes, in case it is not enough -->
                <filesets />
            </copy>

            <!-- jar all files -->
            <jar basedir="${@{name}.build.dir}" jarfile="${dist.dir}/${@{name}.id}">
                <manifest>
                    <attribute name="Class-Path" value="${jar.classpath}" />
                </manifest>
            </jar>

            <!-- add an extra step: ejb verifier -->
            <ejb-verifier file="${dist.dir}/${@{name}.id}" />
        </sequential>
    </macrodef>

    <macrodef name="ejb-verifier">
        <attribute name="file" />
        <sequential>
            <echo message="Verifying EJB jar @{file}" />
            <java classname="org.jboss.verifier.Main" fork="true">
                <classpath>
                    <fileset dir="${jboss.home}/server/default/lib" includes="*.jar" />
                    <fileset dir="${jboss.home}/client" includes="*.jar" />
                    <fileset dir="${jboss.home}/lib" includes="*.jar" />
                    <fileset dir="${dist.dir}" includes="*.jar" />
                    <pathelement location="${jboss.home}/server/default/conf" />
                </classpath>
                <arg value="@{file}" />
            </java>
        </sequential>
    </macrodef>

    <target name="test:compile" depends="compile" description="compile JUnit testcases">
        <mkdir dir="${test.dir}" />
        <javac srcdir="${test.src.dir}" destdir="${test.dir}" debug="on" includeantruntime="no">
            <classpath refid="test.compile.classpath" />
        </javac>
        <!-- jndi.properties needs to be in the classpath -->
        <copy file="${src.java}/jndi.properties" todir="${test.dir}" />
    </target>

    <target name="test:run" depends="test:compile,j2ee:assert-run" description="run JUnit testcases">
        <delete dir="${test.dir}/reports" />
        <mkdir dir="${test.dir}/reports/html" />
        <junit printsummary="yes" haltonfailure="no">
            <classpath>
                <path refid="test.compile.classpath" />
                <path location="${test.dir}" />
            </classpath>
            <formatter type="xml" />
            <batchtest fork="yes" todir="${test.dir}/reports">
                <fileset dir="${test.dir}">
                    <include name="**/caadmin/TestCAs*" />
                    <exclude name="**/TestRunner*" />
                </fileset>
            </batchtest>
            <batchtest fork="yes" todir="${test.dir}/reports">
                <fileset dir="${test.dir}">
                    <include name="**/util/Test*" />
                    <!-- Messagestesten kräver vissa CA som vi inte kan göra automagisgt
                    <include name="**/protocol/Test*" /> -->
                    <include name="**/ra/Test*" />
                    <!-- LotsosUsers skapar MASSOR med använder, körs bara ibland -->
                    <exclude name="**/ra/TestAddLotsofUsers*" />
                    <include name="**/raadmin/Test*" />
                    <include name="**/auth/Test*" />
                    <include name="**/store/Test*" />
                    <include name="**/sign/Test*" />
                    <include name="**/crl/Test*" />
                    <include name="**/publisher/Test*" />
                    <include name="**/batch/Test*" />
                    <include name="**/log/Test*" />
                    <include name="**/keyrecovery/Test*" />
                    <include name="**/hardtoken/Test*" />
                    <exclude name="**/TestRunner*" />
                </fileset>
            </batchtest>
            <batchtest fork="yes" todir="${test.dir}/reports">
                <fileset dir="${test.dir}">
                    <include name="**/caadmin/TestRemoveCA*" />
                    <exclude name="**/TestRunner*" />
                </fileset>
            </batchtest>
        </junit>
        <junitreport todir="${test.dir}/reports">
            <fileset dir="${test.dir}/reports">
                <include name="TEST-*.xml" />
            </fileset>
            <report format="frames" todir="${test.dir}/reports/html" />
        </junitreport>
    </target>
    
    <macrodef name="jsp-compile">
        <attribute name="uriroot"/>
        <attribute name="todir" default="@{uriroot}"/>
        <attribute name="classpathref"/>
        <sequential>
        <path id="jasper.classpath">
            <fileset dir="lib/jasper" includes="*.jar"/>
            <path refid="@{classpathref}"/>
            <path location="${build}"/>
        </path>
        <taskdef name="jasper2" classname="org.apache.jasper.JspC" classpathref="jasper.classpath"/>
        <mkdir dir="@{todir}/WEB-INF/jspc"/>
        
        <property name="jasper.classpath" refid="jasper.classpath"/>
        <!--echo message="jasper.classpath = ${jasper.classpath}"/-->
		<jasper2 uriroot="@{uriroot}"
			package="org.apache.jasper.jspc"
			outputdir="@{todir}/WEB-INF/jspc"
			validatexml="false"
			webXmlFragment="@{todir}/WEB-INF/generated_web.xml"
			addWebXmlMappings="true"
            verbose="0"
            classpath="${jasper.classpath}"/>
		<!--
		  Compile them cleanly, jasper is not nice for this so use javac directly
		  Note that precompilation may not work with weblogic (see weblogic docs)
		  -->
		<mkdir dir="@{todir}/WEB-INF/classes"/>
		<depend srcdir="@{todir}/WEB-INF/jspc" destdir="@{todir}/WEB-INF/classes">
			<classpath path="${jasper.classpath}"/>
		</depend>
		<javac srcdir="@{todir}/WEB-INF/jspc" destdir="@{todir}/WEB-INF/classes" debug="on"
            includeantruntime="no">
            <classpath path="${jasper.classpath}"/>
        </javac>
        </sequential>
    </macrodef>    
</project>