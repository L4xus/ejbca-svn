    My LINUX+JBOSS+EJBCA+MYSQL+OPENLDAP How To
    originally contributed by <surd0007(at)yahoo.com.cn>
 
(This install guide is a complement to the guide present in README).
$Id: INSTALL-guide.txt,v 1.5 2004-08-25 13:51:19 anatom Exp $

 
 Softwares needed:
 	redhat8.0
 	j2sdk-1_4_0_02-linux-i586.bin
 	jboss-3.0.8.zip
 	ejbca_3_0.zip
 	mysql-3.23.52-3(included in redhat CDs)
 	mysql-connector-java-3.0.8-stable-bin.jar(JDBC driver)
 	openldap-2.1.12(support BDB type)
 	
 
 Install JDK1.4
 	#cp j2sdk-1_4_0_02-linux-i586.bin /usr
 	#cd /usr
 	#chmod 777 j2sdk-1_4_0_02-linux-i586.bin
 	#./j2sdk-1_4_0_02-linux-i586.bin
 	#ln -s j2sdk1.4.0_02 java
 
 
 Install jboss
 	#cp jboss-3.0.8.zip /usr
 	#cd /usr
 	#unzip jboss-3.0.8.zip
 	#cd jboss-3.0.8
 
 
 Install ant
 	#cp apache-ant-1.5.4-bin.tar.gz /usr/j2ee/
 	#tar xvfz apache-ant-1.5.4-bin.tar.gz
 
 
 Configure environment variables
 	add the following text to the tail of /etc/profile:
 
 	export JAVA_HOME=/usr/java
 	export JBOSS_HOME=/usr/jboss-3.0.8
 	export PATH=/usr/java/bin:$PATH:/usr/j2ee/apache-ant-1.5.4/bin
 	export CLASSPATH=/usr/java/jre/lib/ext/:$CLASSPATH
 
 	Notes: In order to make the environment variables valid, logout and login again!
 
 
 Install mysql
 	because there is a bug in mysql included in REDHAT8.0, we need fix it:
 	add the following info to the [mysqld] section in /etc/my.cnf:
 	
 	skip-name-resolve
 	set-variable=thread_stack=256k
 
 	#/etc/rc.d/initd/mysqld restart
 
 	add user "ocsper" with password "123456" and enough privileges. allow user ocsper to
connect to mysql server.
 	create ejbca database under user ocsper.
 
 
 Install EJBCA
 	#cp ejbca_3_0.zip /usr/j2ee
 	#unzip ejbca_3_0.zip
 	#cd ejbca
 
 	Configure mysql:
 	#cd /usr/j2ee/ejbca
    #ant replaceDS -Dejbca.DS=java:/DefaultDS
    choose database mysql.
    
    (this does the below that you don't have to do manually
 	#cp src/ca/ca/META-INF/jbosscmp-jdbc-mysql.xml src/ca/ca/META-INF/jbosscmp-jdbc.xml
 	#cp src/ra/META-INF/jbosscmp-jdbc-mysql.xml src/ra/META-INF/jbosscmp-jdbc.xml
 	#cp src/log/META-INF/jbosscmp-jdbc-mysql.xml src/log/META-INF/jbosscmp-jdbc.xml
 	#cp src/hardtoken/META-INF/jbosscmp-jdbc-mysql.xml src/hardtoken/META-INF/jbosscmp-jdbc.xml
 	#cp src/keyrecovery/META-INF/jbosscmp-jdbc-mysql.xml src/keyrecovery/META-INF/jbosscmp-jdbc.xml
    #cp src/authorization/META-INF/jbosscmp-jdbc-mysql.xml src/authorization/META-INF/jbosscmp-jdbc.xml
    )

 	Compile ejbca source and deploy to application server:
 	#ant deploy 
 
 
 Configure JBOSS:
 	#cp mysql-connector-java-3.0.9-stable.tar.gz /usr
 	#tar xvfz mysql-connector-java-3.0.9-stable.tar.gz
 	#cd mysql-connector-java-3.0.9-stable
 	#cp mysql-connector-java-3.0.9-stable-bin.jar $JBOSS_HOME/server/default/lib/ 
 
 	#cd /usr/j2ee/ejbca
 	#cp doc/mysql-service.xml $JBOSS_HOME/server/default/deploy/
 	#vi $JBOSS_HOME/server/default/deploy/mysql-ds.xml
 	
 	......
    <datasources>
       <local-tx-datasource>
          <jndi-name>DefaultDS</jndi-name>
          <connection-url>jdbc:mysql://localhost:3306/ejbca3</connection-url>
          <driver-class>com.mysql.jdbc.Driver</driver-class>
          <user-name>ejbca</user-name>
          <password>ejbca</password>
          <min-pool-size>5</min-pool-size>
          <max-pool-size>20</max-pool-size>
          <idle-timeout-minutes>15</idle-timeout-minutes>
          <track-statements>true</track-statements>
       </local-tx-datasource>
    </datasources>
 	......
 
 	#cd $JBOSS_HOME/server/default/deploy/
 	#rm hsqldb-ds.xml
 	
 	#vi ../conf/standardjbosscmp-jdbc.xml
 
 	......
      <datasource>java:/DefaultDS</datasource>
      <type-mapping>mySQL</type-mapping>
 	......
 
 	#cd $JBOSS_HOME/bin/
 	#./run.sh   (pay attention to log info, ejbca should deploy without errors)

 	#cd /usr/j2ee/ejbca
 	#./ca.sh init TestCA "C=CN,O=NISEC,CN=EJBCA" 2048 365 null
 
 Configure LDAP
 	/usr/local/etc/openldap/slapd.conf as follows:
 
 	......
 	database        bdb
 	suffix          "O=NISEC,C=CN"
 	rootdn          "CN=Manager,O=NISEC,C=CN"
 	rootpw          ldappasswd
 	directory       /usr/local/var/data
 	index   objectClass     eq
 	......
 
    Use the Admin-GUI to configure publishers to LDAP in EJBCA.
    
    
Users experience using SuSE 9.1 (comes with JBoss installation)
-------------------------------
Here are the steps that I had to follow to get everything
to work on SuSE 9.1 Pro with ejbca 3.0.x:
SuSE 9.1 Pro comes with JBoss. I used the latest release version instead 
(3.2.5) which comes with Tomcat 5. If you use the latest version of JBoss, 
you must make a system user jboss belonging to a group jboss. (You can install 
the SuSE version and uninstall it, and the user will be created for you.) 

1) su to jboss and uncompress both ejbca and jboss

2) As root move them to /usr/ejbca and usr/share/jboss

3) set JBOSS_HOME=/usr/share/jboss

4) As root, edit any of the Web files in /ejbca/src if desired

5) As jboss, go into /usr/ejbca and do
ant deploy

6) As root edit  /usr/share/jboss/bin/jboss_init_suse.sh to use 'default'
rather than 'all'. move it to /etc/init.d/jboss and link that
to /usr/sbin/rcjboss

7) As jboss, in /usr/ejbca
chmod +x *.sh
also in /usr/share/jboss/bin
chmod +x *.sh

8) as root :
Look at the jboss startup file. The SuSE file starts 'all' and this must be
changed to 'default' for jboss to work
start jboss
rcjboss start
It takes several minutes to get it all the way started!

9) As root in /usr/ejbca
./install.sh

10) in /usr/share/jboss/bin

chmod +x tomcat.jks
and change the owner and group to jboss

11) As root:
rcjboss stop
rcjboss start
# Note that it takes a LONG time to stop jboss and an even longer time to start
# it. rcjboss restart with the default SuSE script does not work because the
time is not sufficient.

12) To start things automatically at boot time, as root in /etc/init.d, do
insserv jboss
which places the script in the appropriate startup sections. 
