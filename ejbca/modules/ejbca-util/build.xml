<?xml version="1.0" encoding="UTF-8"?>
<project name="ejbca-util" default="build">
    <description>
            The EJBCA util library
    	
    		The classes in this library are mainly helpers, their dependencies and "value object" classes that are present as method paramters for the EJBCA EJB interfaces.
    		The library are used various places and subprojects. Known uses: ejbca-ejb, ejbca-ejb-cli, ejbca-ws-cli, systemtests, "ocsp-ejb", extra   

    		The only class that depend on the JEE library is the ServiceLocator that makes life easier in the EJB 2.1 world. Other classes should not.
    	
    		Classes that are pure helpers for the EJBCA beans build should be included in the ejbca-ejb package together with the beans. 
    </description>

	<dirname property="this.dir" file="${ant.file.ejbca-util}"/>
	<import file="${this.dir}/../build.xml"/>
	
	<property name="build.dir" location="${this.dir}/build"/>
	<property name="build-test.dir" location="${this.dir}/build-test"/>
	<property name="src.dir" location="${this.dir}/src"/>
	<property name="src-test.dir" location="${this.dir}/src-test"/>
	<property name="reports.base.dir" location="${this.dir}/build-test/reports/"/>

	<path id="compile.classpath">
		<path refid="lib.cert-cvc.classpath"/>
		<path refid="lib.bouncycastle.classpath"/>
		<path refid="lib.log4j.classpath"/>
		<path refid="lib.commons-lang.classpath"/>
		<path refid="lib.commons-config.classpath"/>
		<path refid="lib.commons-collections.classpath"/>
		<path refid="lib.commons-logging.classpath"/>
		<path refid="lib.servlet.classpath"/>
		<path refid="lib.jline.classpath"/>
		<path refid="lib.ldap.classpath"/>
		<path refid="lib.mail.classpath"/>
		<path refid="lib.batik.classpath"/>
		<path refid="lib.xmlsec.classpath"/>
		<path refid="lib.jee.classpath"/>
	</path>

	<path id="test.classpath">
		<path location="${build-test.dir}" />
		<path location="${mod.ejbca-util.lib}" />
		<path refid="compile.classpath"/>
		<path refid="lib.junit.classpath"/>
	</path>

    <target name="build" description="Build this module" depends="compile">
    	<jar destfile="${mod.ejbca-util.lib}">
   			<fileset dir="${build.dir}" includes="**/*.class"/>
        	<fileset dir="${ejbca.home}/src/java">
        	    <include name="dncomponents.properties"/>
        		<include name="profilemappings.properties"/>
        	</fileset>
    	</jar>
    </target>

    <target name="clean" description="Clean up this module">
		<delete dir="${build.dir}" />
		<delete dir="${build-test.dir}" />
		<delete file="${mod.ejbca-util.lib}" />
    </target>
	
    <target name="compile">
    	<mkdir dir="${build.dir}" />
        <javac srcdir="${src.dir}" destdir="${build.dir}" debug="on" includeantruntime="no"
        	encoding="iso8859-1" target="${java.target.version}">
        	<classpath>
        		<path refid="compile.classpath"/>
        	</classpath>
    	</javac>
    </target>

    <target name="compile-tests" depends="build">
    	<mkdir dir="${build-test.dir}" />
        <javac srcdir="${src-test.dir}" destdir="${build-test.dir}" debug="on" includeantruntime="no"
        	encoding="iso8859-1" target="${java.target.version}">
        	<classpath>
				<path location="${mod.ejbca-util.lib}" />
        		<path refid="compile.classpath"/>
        		<path refid="lib.junit.classpath"/>
        	</classpath>
    	</javac>
    </target>

	<target name="test" depends="compile-tests" description="Run tests for this module">
    	<antcall target="showtime"/>
    	<property name="reports.dir" location="${reports.base.dir}/test"/>
		<delete dir="${reports.dir}" />
		<mkdir dir="${reports.dir}/html"/>
        <copy file="${this.dir}/log4j.xml" todir="${build-test.dir}" failonerror="true"/>
        <copy todir="${build-test.dir}" failonerror="true">
        	<fileset dir="${ejbca.home}/src">
			    <include name="intresources/**"/>
			</fileset>
		</copy>
		<junit printsummary="yes" haltonfailure="no" dir="${this.dir}">
			<classpath>
        		<path refid="test.classpath"/>
        		<path refid="lib.clover.classpath"/>
			</classpath>
			<formatter type="xml" />
			<batchtest fork="yes" todir="${reports.dir}">
				<fileset dir="${build-test.dir}" includes="**/*.class">
					<exclude name="org/ejbca/core/model/InternalResourcesTestClass.class"/>
					<exclude name="org/ejbca/core/model/util/AlgorithmToolsHelper*.class"/>
					<exclude name="org/ejbca/core/protocol/ocsp/CacheExceptionHandler.class"/>
					<exclude name="org/ejbca/core/protocol/ocsp/CacheTester.class"/>
					<exclude name="org/ejbca/core/protocol/ocsp/OcspUtilMockups*.class"/>
					<exclude name="org/ejbca/core/protocol/ocsp/OcspUtilMockups*.class"/>
				</fileset>
			</batchtest>
		</junit>
		<antcall target="createreport"/>
    	<antcall target="showtime"/>
    </target>
	
	<target name="runone" depends="compile-tests">
		<fail message="'test.runone' is not set. Example -Dtest.runone=TestDnComponents" unless="test.runone" />
    	<property name="reports.dir" location="${reports.base.dir}/runone"/>
		<delete dir="${reports.dir}" />
		<mkdir dir="${reports.dir}/html"/>
		<junit printsummary="yes" haltonfailure="no" >
			<classpath>
        		<path refid="test.classpath"/>
			</classpath>
			<formatter type="xml" />
			<batchtest fork="yes" todir="${reports.dir}">
				<fileset dir="${build-test.dir}">
					<include name="**/${test.runone}.class" />
				</fileset>
			</batchtest>
		</junit>
		<antcall target="createreport"/>
	</target>

</project>
